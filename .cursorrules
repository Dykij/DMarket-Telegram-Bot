# Cursor AI Rules for DMarket Telegram Bot

> **⚠️ ПЕРВЫЙ ШАГ**: Перед началом любой задачи **ОБЯЗАТЕЛЬНО** изучите файл [`ВАЖНЕЙШИЕ.md`](./ВАЖНЕЙШИЕ.md) в корне проекта. Он содержит приоритетные улучшения и текущий roadmap.

---

## Project Context

DMarket Telegram Bot - Python 3.11+ async trading bot for DMarket and Waxpeer marketplaces.

## General Principles

- Use async/await for ALL I/O operations
- Always add type annotations (Python 3.11+ syntax)
- Follow Google-style docstrings
- Use structlog for logging with context
- Keep functions under 50 lines
- Maximum 3 levels of nesting (use early returns)

## Python Code Style

- `list[str]` not `List[str]`
- `str | None` not `Optional[str]`
- `dict[str, Any]` not `Dict[str, Any]`
- Use `httpx.AsyncClient` for HTTP requests
- Use `asyncio.gather()` for parallel execution

## Error Handling

- Never use bare `except:`
- Catch specific exception types
- Always log errors with context
- Re-raise or return meaningful messages

## Testing Standards

- Use AAA pattern: Arrange, Act, Assert
- Test names: `test_<function>_<condition>_<expected>`
- Use `@pytest.mark.asyncio` for async tests
- Use `AsyncMock` for mocking async functions
- Mock at boundaries (API clients, DB)

## API Price Formats

- **DMarket**: Prices in CENTS (1000 = $10.00)
- **Waxpeer**: Prices in MILS (1000 = $1.00)
- **Internal**: Always convert to dollars for display

## Imports Order

1. Standard library
2. Third-party packages
3. Local modules

## Files to Never Modify

- `.github/agents/*` - Agent configurations
- `alembic/versions/*` - Database migrations (create new instead)

## Preferred Libraries

- HTTP: `httpx` (not `requests`)
- Logging: `structlog` (not `logging`)
- Cache: `aiocache` with Redis backend
- Validation: `pydantic` v2

## Commands

```bash
pytest tests/ -v              # Run all tests
ruff check src/ tests/        # Lint code
ruff format src/ tests/       # Format code
mypy src/                     # Type check
```

## Context7 MCP Integration

Use Context7 MCP for up-to-date library documentation when generating code.

### Auto-invoke Rule

```
Always use Context7 MCP when I need library/API documentation, 
code generation, setup or configuration steps.
```

### Key Libraries

| Library | Context7 ID | Use Case |
|---------|-------------|----------|
| httpx | `/encode/httpx` | Async HTTP |
| python-telegram-bot | `/python-telegram-bot/python-telegram-bot` | Bot handlers |
| SQLAlchemy | `/sqlalchemy/sqlalchemy` | Database ORM |
| Pydantic | `/pydantic/pydantic` | Validation |
| pytest | `/pytest-dev/pytest` | Testing |
| structlog | `/hynek/structlog` | Logging |
| redis-py | `/redis/redis-py` | Caching |
| ruff | `/astral-sh/ruff` | Linting |
| mypy | `/python/mypy` | Type checking |
| scikit-learn | `/scikit-learn/scikit-learn` | ML predictions |
| pandas | `/pandas-dev/pandas` | Data analysis |
| cryptography | `/pyca/cryptography` | Security |

### Usage

```
Создай async API клиент. use library /encode/httpx for API and docs.
```

Full library list: `docs/AI_TOOLS_CONFIG.md`

## MCP Servers Configuration

For enhanced development, configure these MCP servers in Cursor:

### ~/.cursor/mcp.json

```json
{
  "mcpServers": {
    "context7": {
      "url": "https://mcp.context7.com/mcp",
      "headers": { "CONTEXT7_API_KEY": "YOUR_KEY" }
    },
    "sqlite": {
      "command": "npx",
      "args": ["-y", "@anthropic/mcp-sqlite", "--db", "data/bot.db"]
    },
    "github": {
      "command": "npx", 
      "args": ["-y", "@anthropic/mcp-github"],
      "env": { "GITHUB_TOKEN": "ghp_xxx" }
    },
    "fetch": {
      "command": "npx",
      "args": ["-y", "@anthropic/mcp-fetch"]
    },
    "sequential-thinking": {
      "command": "npx",
      "args": ["-y", "@anthropic/mcp-sequential-thinking"]
    },
    "playwright": {
      "command": "npx",
      "args": ["-y", "@anthropic/mcp-playwright"]
    }
  }
}
```

### MCP Server Priority

| Server | Priority | Use Case |
|--------|----------|----------|
| SQLite | ⭐⭐⭐⭐⭐ | DB queries via natural language |
| GitHub | ⭐⭐⭐⭐ | Issues, PRs management |
| Fetch | ⭐⭐⭐⭐ | Live DMarket API docs |
| Context7 | ⭐⭐⭐⭐ | Library documentation |
| Sequential | ⭐⭐⭐ | Complex algorithm reasoning |
| Playwright | ⭐⭐⭐ | Price parsing, E2E tests |
