# Makefile for DMarket Bot project management
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã: Ruff, Black, MyPy, pytest

.PHONY: help install dev clean lint format test test-cov coverage docs run check-types qa docker-build docker-run docker-stop pre-commit setup all fix check

# ============================================================================
# –ü–ï–†–ï–ú–ï–ù–ù–´–ï
# ============================================================================

PYTHON := python
PIP := $(PYTHON) -m pip
VENV := .venv
VENV_BIN := $(VENV)/Scripts
VENV_PYTHON := $(VENV_BIN)/python
VENV_PIP := $(VENV_PYTHON) -m pip
PROJECT_NAME := dmarket-telegram-bot

# ============================================================================
# –û–°–ù–û–í–ù–´–ï –ö–û–ú–ê–ù–î–´
# ============================================================================

# –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º
help:
	@echo "============================================================================"
	@echo "  DMarket Bot - Makefile –∫–æ–º–∞–Ω–¥—ã"
	@echo "============================================================================"
	@echo ""
	@echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞:"
	@echo "  setup          - –ü–æ–ª–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏"
	@echo "  install        - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞"
	@echo "  dev            - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏"
	@echo ""
	@echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞:"
	@echo "  lint           - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ –ª–∏–Ω—Ç–µ—Ä–æ–º (Ruff)"
	@echo "  format         - –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ (Ruff format)"
	@echo "  check-types    - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ (MyPy)"
	@echo "  fix            - –ê–≤—Ç–æ–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ + —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"
	@echo "  check          - –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (lint + types + format)"
	@echo "  qa             - Quality Assurance (–≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ + —Ç–µ—Å—Ç—ã)"
	@echo ""
	@echo "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:"
	@echo "  test           - –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤"
	@echo "  test-cov       - –¢–µ—Å—Ç—ã —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º –∫–æ–¥–∞"
	@echo "  coverage       - –î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –æ –ø–æ–∫—Ä—ã—Ç–∏–∏"
	@echo ""
	@echo "–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞:"
	@echo "  run            - –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞"
	@echo "  clean          - –û—á–∏—Å—Ç–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã"
	@echo "  docs           - –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é"
	@echo "  pre-commit     - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å pre-commit —Ö—É–∫–∏"
	@echo ""
	@echo "Docker:"
	@echo "  docker-build   - –°–æ–±—Ä–∞—Ç—å Docker –æ–±—Ä–∞–∑"
	@echo "  docker-run     - –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤ Docker"
	@echo "  docker-stop    - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
	@echo ""
	@echo "–ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ:"
	@echo "  all            - –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ + —Å–±–æ—Ä–∫–∞"
	@echo ""
	@echo "============================================================================"

# ============================================================================
# –£–°–¢–ê–ù–û–í–ö–ê –ò –ù–ê–°–¢–†–û–ô–ö–ê
# ============================================================================

# –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
$(VENV):
	$(PYTHON) -m venv $(VENV)

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –ø—Ä–æ–µ–∫—Ç–∞
install: $(VENV)
	@echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
	$(VENV_PIP) install --upgrade pip setuptools wheel
	$(VENV_PIP) install -r requirements.txt

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
dev: $(VENV)
	@echo "üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ dev –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
	$(VENV_PIP) install --upgrade pip setuptools wheel
	$(VENV_PIP) install -e ".[dev]"
	@echo "‚úÖ Dev –æ–∫—Ä—É–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ!"

# –ü–æ–ª–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
setup: $(VENV) install dev pre-commit
	@echo "‚úÖ –û–∫—Ä—É–∂–µ–Ω–∏–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ!"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ pre-commit —Ö—É–∫–æ–≤
pre-commit: $(VENV)
	@echo "ü™ù –£—Å—Ç–∞–Ω–æ–≤–∫–∞ pre-commit —Ö—É–∫–æ–≤..."
	$(VENV_BIN)/pre-commit install

# ============================================================================
# –ü–†–û–í–ï–†–ö–ê –ö–ê–ß–ï–°–¢–í–ê –ö–û–î–ê
# ============================================================================

# –õ–∏–Ω—Ç–∏–Ω–≥ –∫–æ–¥–∞ —Å Ruff
lint: $(VENV)
	@echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ –ª–∏–Ω—Ç–µ—Ä–æ–º..."
	$(VENV_BIN)/ruff check .

# –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
format: $(VENV)
	@echo "‚ú® –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞..."
	$(VENV_BIN)/ruff format .

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ —Å MyPy
check-types: $(VENV)
	@echo "üîé –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤..."
	$(VENV_BIN)/mypy src/

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ + —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
fix: $(VENV)
	@echo "üîß –ê–≤—Ç–æ–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ..."
	$(VENV_BIN)/ruff check . --fix
	$(VENV_BIN)/ruff format .
	@echo "‚úÖ –ö–æ–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –∏ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω!"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
check-format: $(VENV)
	@echo "üìè –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è..."
	$(VENV_BIN)/ruff format --check .

# –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ (lint + types + format check)
check: $(VENV)
	@echo "üéØ –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞..."
	@echo ""
	@echo "1Ô∏è‚É£ –õ–∏–Ω—Ç–∏–Ω–≥..."
	$(VENV_BIN)/ruff check .
	@echo ""
	@echo "2Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è..."
	$(VENV_BIN)/ruff format --check .
	@echo ""
	@echo "3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤..."
	$(VENV_BIN)/mypy src/
	@echo ""
	@echo "‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã!"

# Quality Assurance - –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ + —Ç–µ—Å—Ç—ã
qa: check test-cov
	@echo ""
	@echo "‚úÖ Quality Assurance –ø—Ä–æ–π–¥–µ–Ω —É—Å–ø–µ—à–Ω–æ!"

# ============================================================================
# –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï
# ============================================================================

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
test: $(VENV)
	@echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
	$(VENV_BIN)/pytest

# –¢–µ—Å—Ç—ã —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º –∫–æ–¥–∞
test-cov: $(VENV)
	@echo "üìä –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å –∏–∑–º–µ—Ä–µ–Ω–∏–µ–º –ø–æ–∫—Ä—ã—Ç–∏—è..."
	$(VENV_BIN)/pytest --cov=src --cov-report=html --cov-report=term-missing --cov-report=xml

# –î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –æ –ø–æ–∫—Ä—ã—Ç–∏–∏
coverage: test-cov
	@echo "üìà –û—Ç–∫—Ä—ã—Ç—å HTML –æ—Ç—á–µ—Ç: htmlcov/index.html"

# –ë—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã (–±–µ–∑ –ø–æ–∫—Ä—ã—Ç–∏—è)
test-fast: $(VENV)
	@echo "‚ö° –ë—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã..."
	$(VENV_BIN)/pytest -x --ff

# ============================================================================
# –†–ê–ó–†–ê–ë–û–¢–ö–ê
# ============================================================================

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
run: $(VENV)
	@echo "üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞..."
	$(VENV_PYTHON) -m src.main

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
docs: $(VENV)
	@echo "üìö –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏..."
	$(VENV_BIN)/sphinx-build -b html docs/source docs/build/html

# –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
clean:
	@echo "üßπ –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
	if exist build rmdir /s /q build
	if exist dist rmdir /s /q dist
	if exist htmlcov rmdir /s /q htmlcov
	if exist .pytest_cache rmdir /s /q .pytest_cache
	if exist .ruff_cache rmdir /s /q .ruff_cache
	if exist .mypy_cache rmdir /s /q .mypy_cache
	if exist coverage.xml del /q coverage.xml
	if exist coverage.json del /q coverage.json
	if exist .coverage del /q .coverage
	for /d /r %%i in (__pycache__) do @if exist "%%i" rmdir /s /q "%%i"
	for /d /r %%i in (*.egg-info) do @if exist "%%i" rmdir /s /q "%%i"
	@echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"

# ============================================================================
# DOCKER
# ============================================================================

# –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞
docker-build:
	@echo "üê≥ –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞..."
	docker-compose build

# –ó–∞–ø—É—Å–∫ –≤ Docker
docker-run:
	@echo "üê≥ –ó–∞–ø—É—Å–∫ –≤ Docker..."
	docker-compose up -d

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
docker-stop:
	@echo "üê≥ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker..."
	docker-compose down

# –õ–æ–≥–∏ Docker
docker-logs:
	docker-compose logs -f

# ============================================================================
# –ö–û–ú–ë–ò–ù–ò–†–û–í–ê–ù–ù–´–ï –ö–û–ú–ê–ù–î–´
# ============================================================================

# –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ + —Å–±–æ—Ä–∫–∞
all: clean qa docs docker-build
	@echo ""
	@echo "‚úÖ –í—Å–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"

# –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∫–æ–º–º–∏—Ç—É
pre-push: fix check test-cov
	@echo ""
	@echo "‚úÖ –ì–æ—Ç–æ–≤–æ –∫ push!"


