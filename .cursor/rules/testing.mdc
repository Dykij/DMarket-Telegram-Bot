---
description: "Testing standards for pytest test files"
globs: ["tests/**/*.py"]
alwaysApply: true
---

# Test File Rules

## Test Structure
- Use AAA pattern: Arrange, Act, Assert
- One assertion focus per test
- Descriptive names: `test_<function>_<condition>_<expected>`

## Async Tests
- Use `@pytest.mark.asyncio` decorator
- Use `AsyncMock` for mocking async functions
- Mock external dependencies (API, DB, Redis)

## Fixtures
- Define reusable fixtures in `conftest.py`
- Use appropriate scope (function, module, session)
- Clean up resources in teardown

## Mocking
- Mock at boundaries (API client, not internals)
- Verify calls with `assert_called_once_with`
- Use `side_effect` for simulating errors

## Test Data
- Use factories for complex objects
- Keep test data minimal and focused
- Use `@pytest.mark.parametrize` for multiple inputs

## Markers
- `@pytest.mark.slow` for long-running tests
- `@pytest.mark.integration` for integration tests
- `@pytest.mark.e2e` for end-to-end tests

## API Response Formats
- Balance: `{"balance": 100.0}` (dollars)
- DMarket prices: cents (divide by 100)
- Waxpeer prices: mils (divide by 1000)
