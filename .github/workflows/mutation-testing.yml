name: Mutation Testing

on:
  schedule:
    # Run weekly on Saturday at 02:00 UTC
    - cron: '0 2 * * 6'
  workflow_dispatch:
    inputs:
      module:
        description: 'Specific module to test (e.g., src/dmarket/api/)'
        required: false
        type: string
      min_score:
        description: 'Minimum mutation score (%)'
        required: false
        default: '80'
        type: string

env:
  PYTHON_VERSION: "3.11"

permissions:
  contents: read
  issues: write

jobs:
  mutation-testing:
    name: Run Mutation Testing
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2 hours max

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install mutmut pytest pytest-asyncio pytest-mock

      - name: Create test environment
        run: |
          if [ -f .env.example ]; then
            cp .env.example .env
          else
            echo "TELEGRAM_BOT_TOKEN=test" > .env
            echo "DMARKET_PUBLIC_KEY=test" >> .env
            echo "DMARKET_SECRET_KEY=test" >> .env
          fi

      - name: Run mutation testing
        id: mutation
        run: |
          export PYTHONPATH=$GITHUB_WORKSPACE:$PYTHONPATH

          MODULE="${{ github.event.inputs.module || 'src/dmarket/api/' }}"
          MIN_SCORE="${{ github.event.inputs.min_score || '80' }}"

          echo "Running mutation testing on: $MODULE"
          echo "Minimum score: $MIN_SCORE%"

          # Run mutmut with timeout per mutation
          mutmut run \
            --paths-to-mutate "$MODULE" \
            --tests-dir tests/ \
            --runner "pytest -x -q --tb=no" \
            --CI \
            || true

          # Get results
          mutmut results > mutation_results.txt 2>&1 || true
          mutmut html || true

          # Parse results
          KILLED=$(grep -oP 'Killed: \K\d+' mutation_results.txt || echo "0")
          SURVIVED=$(grep -oP 'Survived: \K\d+' mutation_results.txt || echo "0")
          TOTAL=$((KILLED + SURVIVED))

          if [ "$TOTAL" -gt 0 ]; then
            SCORE=$(echo "scale=2; $KILLED * 100 / $TOTAL" | bc)
          else
            SCORE="100"
          fi

          echo "MUTATION_SCORE=$SCORE" >> $GITHUB_OUTPUT
          echo "KILLED=$KILLED" >> $GITHUB_OUTPUT
          echo "SURVIVED=$SURVIVED" >> $GITHUB_OUTPUT
          echo "TOTAL=$TOTAL" >> $GITHUB_OUTPUT

          echo "Mutation Score: $SCORE%"
          echo "Killed: $KILLED / $TOTAL"
        continue-on-error: true
        env:
          PYTHONPATH: ${{ github.workspace }}

      - name: Upload mutation report
        uses: actions/upload-artifact@v6
        with:
          name: mutation-report
          path: |
            htmlmut/
            mutation_results.txt
          retention-days: 30
        continue-on-error: true

      - name: Generate summary
        run: |
          SCORE="${{ steps.mutation.outputs.MUTATION_SCORE || 'N/A' }}"
          KILLED="${{ steps.mutation.outputs.KILLED || '0' }}"
          SURVIVED="${{ steps.mutation.outputs.SURVIVED || '0' }}"
          TOTAL="${{ steps.mutation.outputs.TOTAL || '0' }}"
          MIN_SCORE="${{ github.event.inputs.min_score || '80' }}"

          echo "# ðŸ§¬ Mutation Testing Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Mutation Score** | ${SCORE}% |" >> $GITHUB_STEP_SUMMARY
          echo "| **Mutations Killed** | ${KILLED} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Mutations Survived** | ${SURVIVED} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total Mutations** | ${TOTAL} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Minimum Required** | ${MIN_SCORE}% |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$SCORE" != "N/A" ]; then
            if (( $(echo "$SCORE >= $MIN_SCORE" | bc -l) )); then
              echo "## âœ… PASSED" >> $GITHUB_STEP_SUMMARY
              echo "Mutation score meets the minimum requirement." >> $GITHUB_STEP_SUMMARY
            else
              echo "## âš ï¸ Below Threshold" >> $GITHUB_STEP_SUMMARY
              echo "Mutation score is below the minimum requirement of ${MIN_SCORE}%." >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Recommendations" >> $GITHUB_STEP_SUMMARY
              echo "- Add more edge case tests" >> $GITHUB_STEP_SUMMARY
              echo "- Improve assertion specificity" >> $GITHUB_STEP_SUMMARY
              echo "- Test boundary conditions" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Check threshold
        run: |
          SCORE="${{ steps.mutation.outputs.MUTATION_SCORE || '0' }}"
          MIN_SCORE="${{ github.event.inputs.min_score || '80' }}"

          if (( $(echo "$SCORE < $MIN_SCORE" | bc -l) )); then
            echo "::warning::Mutation score ($SCORE%) is below minimum ($MIN_SCORE%)"
          fi
        continue-on-error: true

  notify-on-failure:
    name: Notify on Low Score
    runs-on: ubuntu-latest
    needs: mutation-testing
    if: failure()

    steps:
      - name: Create issue for low mutation score
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ðŸ§¬ Mutation Testing Score Below Threshold';
            const body = `
            ## Mutation Testing Alert

            The weekly mutation testing run detected a mutation score below the threshold.

            **Action Required**: Review and improve test quality to catch more mutations.

            ### How to Fix

            1. Review the mutation report artifact
            2. Add tests for survived mutations
            3. Improve assertion specificity

            **Workflow Run**: [Link](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            `;

            // Check if similar issue exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'mutation-testing'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['mutation-testing', 'test-quality']
              });
            }
        continue-on-error: true
