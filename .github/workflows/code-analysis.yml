name: Code Analysis (Compact)

# ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½ Ð´Ð»Ñ Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð²Ñ‹Ð²Ð¾Ð´Ð° Ð»Ð¾Ð³Ð¾Ð²
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: write

# ÐžÐ³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ðµ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ
defaults:
  run:
    shell: bash

jobs:
  deep-analysis:
    name: Code Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10  # ÐžÐ³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ðµ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚ (Ð±Ñ‹ÑÑ‚Ñ€ÐµÐµ)

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install tools
        run: pip install -q ruff mypy bandit safety vulture radon xenon 2>/dev/null

      - name: Ruff Check
        continue-on-error: true
        run: |
          echo "## ðŸ” Ruff" >> $GITHUB_STEP_SUMMARY
          ruff check src/ tests/ --output-format=concise 2>/dev/null | head -20 || echo "âœ… OK" >> $GITHUB_STEP_SUMMARY

      - name: MyPy Check
        continue-on-error: true
        run: |
          echo "## ðŸ·ï¸ MyPy" >> $GITHUB_STEP_SUMMARY
          mypy src/ --ignore-missing-imports --no-error-summary 2>&1 | head -20 || echo "âœ… OK" >> $GITHUB_STEP_SUMMARY

      - name: Bandit Security
        continue-on-error: true
        run: |
          echo "## ðŸ”’ Security" >> $GITHUB_STEP_SUMMARY
          bandit -r src/ -f json -o bandit-report.json -q 2>/dev/null || true
          echo "Report saved to artifact" >> $GITHUB_STEP_SUMMARY

      - name: Vulture Dead Code
        continue-on-error: true
        run: |
          echo "## ðŸ’€ Dead Code" >> $GITHUB_STEP_SUMMARY
          vulture src/ --min-confidence 90 2>/dev/null | head -10 || echo "âœ… OK" >> $GITHUB_STEP_SUMMARY

      - name: Complexity Check
        continue-on-error: true
        run: |
          echo "## ðŸ“Š Complexity" >> $GITHUB_STEP_SUMMARY
          xenon --max-absolute B --max-modules B --max-average A src/ 2>/dev/null && echo "âœ… OK" >> $GITHUB_STEP_SUMMARY || echo "âš ï¸ High complexity detected" >> $GITHUB_STEP_SUMMARY

      - name: Safety Check
        continue-on-error: true
        run: |
          echo "## ðŸ“¦ Dependencies" >> $GITHUB_STEP_SUMMARY
          [ -f requirements.txt ] && safety check -r requirements.txt --output json > safety-report.json 2>/dev/null || true
          echo "Report saved to artifact" >> $GITHUB_STEP_SUMMARY

      - name: Summary
        run: echo "## âœ… Done at $(date +%H:%M)" >> $GITHUB_STEP_SUMMARY

      - name: Upload Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: analysis-reports
          path: |
            bandit-report.json
            safety-report.json
          retention-days: 7
          if-no-files-found: ignore
