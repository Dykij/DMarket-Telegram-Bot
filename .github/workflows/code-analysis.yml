name: Code Analysis (Adrenaline-style)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:  # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  deep-analysis:
    name: Deep Code Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy bandit safety vulture radon xenon

      - name: Run Ruff (Linting + Formatting Check)
        continue-on-error: true
        run: |
          echo "## ðŸ” Ruff Analysis" >> $GITHUB_STEP_SUMMARY
          ruff check src/ tests/ --output-format=github || echo "Ruff found issues" >> $GITHUB_STEP_SUMMARY
          ruff format src/ tests/ --check || echo "Formatting issues found" >> $GITHUB_STEP_SUMMARY

      - name: Run MyPy (Type Checking)
        continue-on-error: true
        run: |
          echo "## ðŸ·ï¸ MyPy Type Analysis" >> $GITHUB_STEP_SUMMARY
          mypy src/ --ignore-missing-imports --no-error-summary 2>&1 | head -100 || true

      - name: Run Bandit (Security Analysis)
        continue-on-error: true
        run: |
          echo "## ðŸ”’ Security Analysis (Bandit)" >> $GITHUB_STEP_SUMMARY
          bandit -r src/ -f json -o bandit-report.json || true
          bandit -r src/ -f txt --severity-level medium || echo "Security issues found" >> $GITHUB_STEP_SUMMARY

      - name: Run Vulture (Dead Code Detection)
        continue-on-error: true
        run: |
          echo "## ðŸ’€ Dead Code Analysis (Vulture)" >> $GITHUB_STEP_SUMMARY
          vulture src/ --min-confidence 80 || echo "Potentially dead code found" >> $GITHUB_STEP_SUMMARY

      - name: Run Radon (Complexity Analysis)
        continue-on-error: true
        run: |
          echo "## ðŸ“Š Complexity Analysis (Radon)" >> $GITHUB_STEP_SUMMARY
          echo "### Cyclomatic Complexity (CC)" >> $GITHUB_STEP_SUMMARY
          radon cc src/ -a -s --total-average || true
          echo "### Maintainability Index (MI)" >> $GITHUB_STEP_SUMMARY
          radon mi src/ -s || true

      - name: Run Xenon (Complexity Threshold Check)
        continue-on-error: true
        run: |
          echo "## âš ï¸ Complexity Threshold Check (Xenon)" >> $GITHUB_STEP_SUMMARY
          xenon --max-absolute B --max-modules B --max-average A src/ || echo "Complexity threshold exceeded" >> $GITHUB_STEP_SUMMARY

      - name: Safety Check (Vulnerable Dependencies)
        continue-on-error: true
        run: |
          echo "## ðŸ“¦ Dependency Vulnerability Check" >> $GITHUB_STEP_SUMMARY
          if [ -f requirements.txt ]; then
            safety check -r requirements.txt --output json > safety-report.json 2>/dev/null || true
            safety check -r requirements.txt 2>/dev/null || echo "Vulnerable dependencies found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Generate Summary Report
        run: |
          echo "## âœ… Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo "Analysis completed at $(date)" >> $GITHUB_STEP_SUMMARY

      - name: Upload Analysis Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: analysis-reports
          path: |
            bandit-report.json
            safety-report.json
          retention-days: 30

  architecture-analysis:
    name: Architecture Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install pipdeptree pylint

      - name: Dependency Tree Analysis
        continue-on-error: true
        run: |
          echo "## ðŸŒ³ Dependency Tree" >> $GITHUB_STEP_SUMMARY
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt -q 2>/dev/null || true
            pipdeptree --warn silence 2>/dev/null | head -50 || true
          fi

      - name: Module Import Analysis
        continue-on-error: true
        run: |
          echo "## ðŸ“ Module Structure" >> $GITHUB_STEP_SUMMARY
          find src -name "*.py" -type f | wc -l | xargs -I {} echo "Total Python files: {}" >> $GITHUB_STEP_SUMMARY
          find src -name "*.py" -type f -exec grep -l "^class " {} \; | wc -l | xargs -I {} echo "Files with classes: {}" >> $GITHUB_STEP_SUMMARY
          find src -name "*.py" -type f -exec grep -l "^async def\|^def " {} \; | wc -l | xargs -I {} echo "Files with functions: {}" >> $GITHUB_STEP_SUMMARY

      - name: Check for Circular Imports
        continue-on-error: true
        run: |
          echo "## ðŸ”„ Circular Import Check" >> $GITHUB_STEP_SUMMARY
          python -c "
          import ast
          import os
          from collections import defaultdict
          
          imports = defaultdict(set)
          for root, dirs, files in os.walk('src'):
              for f in files:
                  if f.endswith('.py'):
                      path = os.path.join(root, f)
                      try:
                          with open(path) as file:
                              tree = ast.parse(file.read())
                          module = path.replace('/', '.').replace('.py', '')
                          for node in ast.walk(tree):
                              if isinstance(node, ast.Import):
                                  for alias in node.names:
                                      imports[module].add(alias.name)
                              elif isinstance(node, ast.ImportFrom) and node.module:
                                  imports[module].add(node.module)
                      except:
                          pass
          
          # Simple cycle detection
          cycles = []
          for mod, deps in imports.items():
              for dep in deps:
                  if dep in imports and mod in imports.get(dep, set()):
                      cycles.append(f'{mod} <-> {dep}')
          
          if cycles:
              print(f'Potential circular imports: {len(set(cycles))}')
              for c in list(set(cycles))[:5]:
                  print(f'  - {c}')
          else:
              print('No obvious circular imports detected')
          " || echo "Analysis completed" >> $GITHUB_STEP_SUMMARY
