name: Python Tests

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - '**.py'
      - 'requirements.txt'
      - 'pyproject.toml'
      - '.github/workflows/python-tests.yml'
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - '**.py'
      - 'requirements.txt'
      - 'pyproject.toml'
      - '.github/workflows/python-tests.yml'
  schedule:
    - cron: '0 6 * * *'  # Ð•Ð¶ÐµÐ´Ð½ÐµÐ²Ð½Ð¾ Ð² 06:00 UTC
  workflow_dispatch:  # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: write
  pull-requests: write  # Ð”Ð»Ñ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸ÐµÐ² Ñ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð°Ð¼Ð¸

env:
  PYTHON_VERSION: '3.11'
  MIN_COVERAGE: 15  # ÐœÐ¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ Ñ‚ÐµÑÑ‚Ð°Ð¼Ð¸ (Ñ€ÐµÐ°Ð»Ð¸ÑÑ‚Ð¸Ñ‡Ð½Ð°Ñ Ñ†ÐµÐ»ÑŒ)
  CACHE_VERSION: v1
  PIP_CACHE_DIR: ~/.cache/pip

jobs:
  test:
    name: Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    timeout-minutes: 15

    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12']
        include:
          - python-version: '3.11'
            upload-coverage: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # ÐŸÐ¾Ð»Ð½Ð°Ñ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð´Ð»Ñ Ð»ÑƒÑ‡ÑˆÐµÐ³Ð¾ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            pyproject.toml

      - name: Cache pip dependencies
        uses: actions/cache@v5
        id: pip-cache
        with:
          path: |
            ~/.cache/pip
            .pytest_cache
            .mypy_cache
            .ruff_cache
          key: ${{ runner.os }}-pip-${{ env.CACHE_VERSION }}-py${{ matrix.python-version }}-${{ hashFiles('requirements.txt', 'pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ env.CACHE_VERSION }}-py${{ matrix.python-version }}-
            ${{ runner.os }}-pip-${{ env.CACHE_VERSION }}-

      - name: Cache hit status
        run: |
          if [ "${{ steps.pip-cache.outputs.cache-hit }}" == "true" ]; then
            echo "âœ… Cache restored successfully"
          else
            echo "âš ï¸ Cache miss - full install required"
          fi

      - name: Install dependencies
        run: |
          echo "ðŸ“¦ Installing dependencies..."
          python -m pip install --upgrade pip setuptools wheel

          # Install testing tools first
          echo "âœ… Installing testing tools..."
          pip install pytest pytest-asyncio pytest-cov pytest-mock pytest-xdist pytest-timeout pytest-rerunfailures pytest-randomly

          # Install project dependencies
          if [ -f requirements.txt ]; then
            echo "âœ… Installing from requirements.txt..."
            pip install -r requirements.txt || echo "::warning::Some dependencies failed to install"
          elif [ -f pyproject.toml ]; then
            echo "âœ… Installing from pyproject.toml..."
            pip install -e ".[dev]" || echo "::warning::Error installing from pyproject.toml"
          fi

          # Create .env for tests
          if [ -f .env.example ]; then
            cp .env.example .env
          else
            cat > .env << EOF
          TELEGRAM_BOT_TOKEN=test_token
          DMARKET_PUBLIC_KEY=test_public_key
          DMARKET_SECRET_KEY=test_secret_key
          DATABASE_URL=sqlite:///:memory:
          TESTING=true
          EOF
          fi

          echo "âœ… Dependencies installed"

      - name: Run pre-commit checks
        if: matrix.python-version == '3.11'
        run: |
          echo "ðŸ” Running pre-commit checks..."
          pip install pre-commit
          pre-commit run --all-files --show-diff-on-failure || echo "::warning::Some pre-commit checks failed"
        continue-on-error: true

      - name: Run tests with pytest
        id: pytest
        run: |
          echo "ðŸ§ª Running tests with coverage..."

          # Create report directories
          mkdir -p build/test-results build/coverage

          # Check if tests exist
          if [ ! -d "tests" ] || [ -z "$(find tests -name 'test_*.py' -o -name '*_test.py' 2>/dev/null)" ]; then
            echo "::warning::No tests found"
            echo "test_failed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Run tests in parallel with retry for flaky tests
          python -m pytest tests/ \
            --cov=src \
            --cov-report=xml:build/coverage/coverage.xml \
            --cov-report=html:build/coverage/html \
            --cov-report=term-missing \
            --cov-fail-under=${{ env.MIN_COVERAGE }} \
            --junitxml=build/test-results/junit.xml \
            --maxfail=3 \
            --reruns 2 \
            --reruns-delay 1 \
            --timeout=30 \
            --durations=10 \
            -v \
            -n auto \
            --tb=short \
            -k "not integration and not slow" \
            && echo "test_failed=false" >> $GITHUB_OUTPUT \
            || { echo "test_failed=true" >> $GITHUB_OUTPUT; echo "::error::Tests failed - coverage threshold not met or test failures"; exit 1; }

          echo "âœ… Tests completed"
        env:
          PYTHONPATH: ${{ github.workspace }}
          DMARKET_PUBLIC_KEY: 'test_public_key'
          DMARKET_SECRET_KEY: 'test_secret_key'
          TELEGRAM_BOT_TOKEN: 'test_token'
          DATABASE_URL: 'sqlite:///:memory:'
          TESTING: 'true'
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check coverage threshold
        if: always()
        run: |
          echo "ðŸ“Š ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ñ€Ð¾Ð³Ð° Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ñ ÐºÐ¾Ð´Ð°..."

          if [ -f build/coverage/coverage.xml ]; then
            # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ð¸Ð· XML
            COVERAGE=$(python -c "import xml.etree.ElementTree as ET; tree = ET.parse('build/coverage/coverage.xml'); root = tree.getroot(); print(root.attrib.get('line-rate', '0'))" 2>/dev/null || echo "0")
            COVERAGE_PERCENT=$(python -c "print(int(float('$COVERAGE') * 100))" 2>/dev/null || echo "0")

            echo "ðŸ“ˆ Ð¢ÐµÐºÑƒÑ‰ÐµÐµ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ: ${COVERAGE_PERCENT}%"
            echo "ðŸŽ¯ ÐœÐ¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ: ${{ env.MIN_COVERAGE }}%"
            echo "coverage_percent=${COVERAGE_PERCENT}" >> $GITHUB_OUTPUT

            if [ $COVERAGE_PERCENT -lt ${{ env.MIN_COVERAGE }} ]; then
              echo "::warning::ÐŸÐ¾ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ ÐºÐ¾Ð´Ð° (${COVERAGE_PERCENT}%) Ð½Ð¸Ð¶Ðµ Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ (${{ env.MIN_COVERAGE }}%)"
            else
              echo "âœ… ÐŸÐ¾ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ ÐºÐ¾Ð´Ð° ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸ÑÐ¼"
            fi
          else
            echo "::warning::Ð¤Ð°Ð¹Ð» Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
          fi
        continue-on-error: true

      - name: Upload coverage to Codecov
        if: matrix.upload-coverage && hashFiles('build/coverage/coverage.xml') != ''
        uses: codecov/codecov-action@v5
        with:
          files: ./build/coverage/coverage.xml
          fail_ci_if_error: false
          flags: python-${{ matrix.python-version }}
          token: ${{ secrets.CODECOV_TOKEN }}
        continue-on-error: true

      - name: Verify test results file
        if: always()
        run: |
          if [ -f build/test-results/junit.xml ]; then
            echo "âœ… JUnit XML file exists"
            echo "ðŸ“Š File size: $(stat -f%z build/test-results/junit.xml 2>/dev/null || stat -c%s build/test-results/junit.xml)"
            echo "ðŸ“„ First 10 lines:"
            head -n 10 build/test-results/junit.xml
          else
            echo "âŒ JUnit XML file not found!"
            echo "ðŸ“ Contents of build/test-results/:"
            ls -la build/test-results/ || echo "Directory does not exist"
          fi
        continue-on-error: true

      - name: Upload test results to Codecov
        if: ${{ !cancelled() && hashFiles('build/test-results/junit.xml') != '' }}
        uses: codecov/test-results-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./build/test-results/junit.xml
          flags: python-${{ matrix.python-version }}
          verbose: true
        continue-on-error: true

      - name: Archive test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-py${{ matrix.python-version }}
          path: |
            build/test-results/
            build/coverage/
          retention-days: 14
        continue-on-error: true

      - name: Test summary
        if: always()
        run: |
          echo "# ðŸ§ª Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€ | Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Python | ${{ matrix.python-version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Ð¡Ñ‚Ð°Ñ‚ÑƒÑ | ${{ steps.pytest.outputs.test_failed == 'true' && 'âŒ Ð¢ÐµÑÑ‚Ñ‹ Ð¿Ñ€Ð¾Ð²Ð°Ð»ÐµÐ½Ñ‹' || 'âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ð¾' }} |" >> $GITHUB_STEP_SUMMARY

          if [ -f build/coverage/coverage.xml ]; then
            COVERAGE=$(python -c "import xml.etree.ElementTree as ET; tree = ET.parse('build/coverage/coverage.xml'); root = tree.getroot(); print(root.attrib.get('line-rate', '0'))" 2>/dev/null || echo "0")
            COVERAGE_PERCENT=$(python -c "print(int(float('$COVERAGE') * 100))" 2>/dev/null || echo "0")
            echo "| ÐŸÐ¾ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ | ${COVERAGE_PERCENT}% |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… **Ð”Ð°Ñ‚Ð°**: $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
