name: Python Tests

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - '**.py'
      - 'requirements.txt'
      - 'pyproject.toml'
      - '.github/workflows/python-tests.yml'
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - '**.py'
      - 'requirements.txt'
      - 'pyproject.toml'
      - '.github/workflows/python-tests.yml'
  schedule:
    - cron: '0 6 * * *'  # Ð•Ð¶ÐµÐ´Ð½ÐµÐ²Ð½Ð¾ Ð² 06:00 UTC
  workflow_dispatch:  # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: write
  pull-requests: write  # Ð”Ð»Ñ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸ÐµÐ² Ñ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð°Ð¼Ð¸

env:
  PYTHON_VERSION: '3.11'
  MIN_COVERAGE: 15  # ÐœÐ¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ Ñ‚ÐµÑÑ‚Ð°Ð¼Ð¸ (Ñ€ÐµÐ°Ð»Ð¸ÑÑ‚Ð¸Ñ‡Ð½Ð°Ñ Ñ†ÐµÐ»ÑŒ)
  CACHE_VERSION: v1
  PIP_CACHE_DIR: ~/.cache/pip

jobs:
  test:
    name: Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    timeout-minutes: 15

    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12']
        include:
          - python-version: '3.11'
            upload-coverage: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ÐŸÐ¾Ð»Ð½Ð°Ñ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð´Ð»Ñ Ð»ÑƒÑ‡ÑˆÐµÐ³Ð¾ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            pyproject.toml

      - name: Cache dependencies and test tools
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            .pytest_cache
            .mypy_cache
          key: ${{ runner.os }}-test-${{ env.CACHE_VERSION }}-py${{ matrix.python-version }}-${{ hashFiles('requirements.txt', 'pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-test-${{ env.CACHE_VERSION }}-py${{ matrix.python-version }}-
            ${{ runner.os }}-test-${{ env.CACHE_VERSION }}-

      - name: Install dependencies
        run: |
          echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
          python -m pip install --upgrade pip setuptools wheel

          # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð² Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ (Ð²ÑÐµÐ³Ð´Ð° Ð¿ÐµÑ€Ð²Ñ‹Ð¼Ð¸)
          echo "âœ… Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð² Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ..."
          pip install pytest pytest-asyncio pytest-cov pytest-mock pytest-xdist

          # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
          if [ -f requirements.txt ]; then
            echo "âœ… Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¸Ð· requirements.txt..."
            pip install -r requirements.txt || echo "::warning::ÐÐµÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"
          elif [ -f pyproject.toml ]; then
            echo "âœ… Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¸Ð· pyproject.toml..."
            pip install -e . || echo "::warning::ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐµ Ð¸Ð· pyproject.toml"
          fi

          # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð° Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¾Ð²
          if [ -f .env.example ]; then
            cp .env.example .env
          else
            cat > .env << EOF
          TELEGRAM_BOT_TOKEN=test_token
          DMARKET_PUBLIC_KEY=test_public_key
          DMARKET_SECRET_KEY=test_secret_key
          DATABASE_URL=sqlite:///:memory:
          TESTING=true
          EOF
          fi

          echo "âœ… Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"

      - name: Run tests with pytest
        id: pytest
        run: |
          echo "ðŸ§ª Ð—Ð°Ð¿ÑƒÑÐº Ñ‚ÐµÑÑ‚Ð¾Ð² Ñ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸ÐµÐ¼ ÐºÐ¾Ð´Ð°..."

          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð¾Ð²
          mkdir -p build/test-results build/coverage

          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ñ‚ÐµÑÑ‚Ð¾Ð²
          if [ ! -d "tests" ] || [ -z "$(find tests -name 'test_*.py' -o -name '*_test.py' 2>/dev/null)" ]; then
            echo "::warning::Ð¢ÐµÑÑ‚Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹"
            echo "test_failed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ‚ÐµÑÑ‚Ñ‹ Ð¿Ð°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ð¾ Ñ pytest-xdist (Ð½Ðµ Ñ„ÐµÐ¹Ð»Ð¸Ð¼ ÐµÑÐ»Ð¸ Ñ‚ÐµÑÑ‚Ñ‹ Ð¿Ñ€Ð¾Ð²Ð°Ð»Ð¸Ð»Ð¸ÑÑŒ)
          python -m pytest tests/ \
            --cov=src \
            --cov-report=xml:build/coverage/coverage.xml \
            --cov-report=html:build/coverage/html \
            --cov-report=term-missing \
            --junitxml=build/test-results/junit.xml \
            --maxfail=10 \
            -v \
            -n auto \
            --tb=short \
            -k "not integration and not slow" \
            && echo "test_failed=false" >> $GITHUB_OUTPUT \
            || { echo "test_failed=true" >> $GITHUB_OUTPUT; echo "::warning::ÐÐµÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ñ‹ Ð¿Ñ€Ð¾Ð²Ð°Ð»Ð¸Ð»Ð¸ÑÑŒ"; }

          echo "âœ… Ð¢ÐµÑÑ‚Ñ‹ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ñ‹"
        env:
          PYTHONPATH: ${{ github.workspace }}
          DMARKET_PUBLIC_KEY: 'test_public_key'
          DMARKET_SECRET_KEY: 'test_secret_key'
          TELEGRAM_BOT_TOKEN: 'test_token'
          DATABASE_URL: 'sqlite:///:memory:'
          TESTING: 'true'
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check coverage threshold
        if: always()
        run: |
          echo "ðŸ“Š ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð¾Ñ€Ð¾Ð³Ð° Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ñ ÐºÐ¾Ð´Ð°..."

          if [ -f build/coverage/coverage.xml ]; then
            # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ð¸Ð· XML
            COVERAGE=$(python -c "import xml.etree.ElementTree as ET; tree = ET.parse('build/coverage/coverage.xml'); root = tree.getroot(); print(root.attrib.get('line-rate', '0'))" 2>/dev/null || echo "0")
            COVERAGE_PERCENT=$(python -c "print(int(float('$COVERAGE') * 100))" 2>/dev/null || echo "0")

            echo "ðŸ“ˆ Ð¢ÐµÐºÑƒÑ‰ÐµÐµ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ: ${COVERAGE_PERCENT}%"
            echo "ðŸŽ¯ ÐœÐ¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ: ${{ env.MIN_COVERAGE }}%"
            echo "coverage_percent=${COVERAGE_PERCENT}" >> $GITHUB_OUTPUT

            if [ $COVERAGE_PERCENT -lt ${{ env.MIN_COVERAGE }} ]; then
              echo "::warning::ÐŸÐ¾ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ ÐºÐ¾Ð´Ð° (${COVERAGE_PERCENT}%) Ð½Ð¸Ð¶Ðµ Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ (${{ env.MIN_COVERAGE }}%)"
            else
              echo "âœ… ÐŸÐ¾ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ ÐºÐ¾Ð´Ð° ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸ÑÐ¼"
            fi
          else
            echo "::warning::Ð¤Ð°Ð¹Ð» Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
          fi
        continue-on-error: true

      - name: Upload coverage to Codecov
        if: matrix.upload-coverage && hashFiles('build/coverage/coverage.xml') != ''
        uses: codecov/codecov-action@v5
        with:
          files: ./build/coverage/coverage.xml
          fail_ci_if_error: false
          flags: python-${{ matrix.python-version }}
          token: ${{ secrets.CODECOV_TOKEN }}
        continue-on-error: true

      - name: Upload test results to Codecov
        if: ${{ !cancelled() }}
        uses: codecov/test-results-action@v1
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./build/test-results/junit.xml
          flags: python-${{ matrix.python-version }}
        continue-on-error: true

      - name: Archive test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-py${{ matrix.python-version }}
          path: |
            build/test-results/
            build/coverage/
          retention-days: 14
        continue-on-error: true

      - name: Test summary
        if: always()
        run: |
          echo "# ðŸ§ª Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€ | Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| Python | ${{ matrix.python-version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Ð¡Ñ‚Ð°Ñ‚ÑƒÑ | ${{ steps.pytest.outputs.test_failed == 'true' && 'âŒ Ð¢ÐµÑÑ‚Ñ‹ Ð¿Ñ€Ð¾Ð²Ð°Ð»ÐµÐ½Ñ‹' || 'âœ… Ð£ÑÐ¿ÐµÑˆÐ½Ð¾' }} |" >> $GITHUB_STEP_SUMMARY

          if [ -f build/coverage/coverage.xml ]; then
            COVERAGE=$(python -c "import xml.etree.ElementTree as ET; tree = ET.parse('build/coverage/coverage.xml'); root = tree.getroot(); print(root.attrib.get('line-rate', '0'))" 2>/dev/null || echo "0")
            COVERAGE_PERCENT=$(python -c "print(int(float('$COVERAGE') * 100))" 2>/dev/null || echo "0")
            echo "| ÐŸÐ¾ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ | ${COVERAGE_PERCENT}% |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… **Ð”Ð°Ñ‚Ð°**: $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
