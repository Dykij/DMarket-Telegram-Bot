name: CI/CD Health Check

on:
  schedule:
    - cron: '0 */6 * * *'  # –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

permissions:
  contents: read
  issues: write  # –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è issue –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö

env:
  PYTHON_VERSION: '3.11'

jobs:
  monitor:
    name: Monitor CI/CD Health
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests python-dotenv

      - name: Run GitHub Actions monitor
        id: monitor
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ GitHub Actions..."

          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤
          mkdir -p build/reports

          # –ó–∞–ø—É—Å–∫–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä
          python scripts/github_actions_monitor.py || {
            echo "monitor_failed=true" >> $GITHUB_OUTPUT
            echo "::warning::–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –º–æ–Ω–∏—Ç–æ—Ä–∞"
          }

          echo "‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω"

      - name: Check for critical issues
        id: check-issues
        run: |
          echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º..."

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ—Ç—á–µ—Ç–∞
          if [ -f "build/reports/github_actions_report_*.md" ]; then
            REPORT_FILE=$(ls -t build/reports/github_actions_report_*.md | head -1)

            # –ò–∑–≤–ª–µ–∫–∞–µ–º success rate
            SUCCESS_RATE=$(grep -oP 'Success Rate: \K[0-9.]+' "$REPORT_FILE" | head -1 || echo "0")

            echo "success_rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT
            echo "üìà Success Rate: $SUCCESS_RATE%"

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø–æ—Ä–æ–≥
            if (( $(echo "$SUCCESS_RATE < 60.0" | bc -l) )); then
              echo "critical=true" >> $GITHUB_OUTPUT
              echo "::error::–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –Ω–∏–∑–∫–∏–π success rate: $SUCCESS_RATE%"
            else
              echo "critical=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "::warning::–û—Ç—á–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"
            echo "critical=unknown" >> $GITHUB_OUTPUT
          fi

      - name: Upload monitoring report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-health-report
          path: build/reports/
          retention-days: 30

      - name: Create summary
        if: always()
        run: |
          echo "# üè• CI/CD Health Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**–î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check-issues.outputs.success_rate }}" != "" ]; then
            echo "## üìä –ú–µ—Ç—Ä–∏–∫–∏" >> $GITHUB_STEP_SUMMARY
            echo "- **Success Rate**: ${{ steps.check-issues.outputs.success_rate }}%" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "${{ steps.check-issues.outputs.critical }}" == "true" ]; then
              echo "## ‚ö†Ô∏è –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ü—Ä–æ–±–ª–µ–º—ã" >> $GITHUB_STEP_SUMMARY
              echo "Success rate –Ω–∏–∂–µ 60%. –¢—Ä–µ–±—É–µ—Ç—Å—è —Å—Ä–æ—á–Ω–æ–µ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ!" >> $GITHUB_STEP_SUMMARY
            else
              echo "## ‚úÖ –°—Ç–∞—Ç—É—Å" >> $GITHUB_STEP_SUMMARY
              echo "CI/CD pipeline –≤ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "## ‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ" >> $GITHUB_STEP_SUMMARY
            echo "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìÅ –ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –≤ artifacts" >> $GITHUB_STEP_SUMMARY

      - name: Create issue for critical problems
        if: steps.check-issues.outputs.critical == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const successRate = '${{ steps.check-issues.outputs.success_rate }}';

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç—ã–π issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ci-health-critical'
            });

            if (issues.data.length === 0) {
              // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π Success Rate –≤ CI/CD: ${successRate}%`,
                body: `
            ## üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ü—Ä–æ–±–ª–µ–º–∞ CI/CD

            **Success Rate**: ${successRate}%
            **–ü–æ—Ä–æ–≥**: 60%
            **–î–∞—Ç–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è**: ${new Date().toISOString()}

            ### üìä –î–µ—Ç–∞–ª–∏

            CI/CD pipeline –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –Ω–∏–∑–∫–∏–π success rate. –≠—Ç–æ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Å–µ—Ä—å–µ–∑–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å —Ç–µ—Å—Ç–∞–º–∏ –∏–ª–∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π.

            ### üîß –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –î–µ–π—Å—Ç–≤–∏—è

            1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–∏–µ failed workflows
            2. –ò–∑—É—á–∏—Ç–µ –ª–æ–≥–∏ –æ—à–∏–±–æ–∫
            3. –ò—Å–ø—Ä–∞–≤—å—Ç–µ failing tests
            4. –û–±–Ω–æ–≤–∏—Ç–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

            ### üìÅ –û—Ç—á–µ—Ç—ã

            –ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –≤ [GitHub Actions artifacts](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

            ---

            *–≠—Ç–æ—Ç issue —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∏—Å—Ç–µ–º–æ–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞*
                `,
                labels: ['ci-health-critical', 'automated']
              });
            }
