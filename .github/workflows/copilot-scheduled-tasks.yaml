name: Copilot Scheduled Tasks
on:
  schedule:
    # Ежедневно в 02:00 UTC (05:00 MSK)
    - cron: '0 2 * * *'
  workflow_dispatch:  # Ручной запуск

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  daily-code-quality:
    runs-on: ubuntu-latest
    if: github.repository == 'Dykij/DMarket-Telegram-Bot'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Trigger Copilot - Code Quality Check
        run: |
          gh copilot agent start --task "Run code quality checks: ruff check src/ tests/ && mypy src/ && pytest tests/ -m 'not slow' --maxfail=5. Fix any critical issues found."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  weekly-dependency-update:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 2 * * 1'  # Понедельник

    steps:
      - name: Trigger Copilot - Dependency Updates
        run: |
          gh copilot agent start --task "Check for security updates in requirements.txt using safety check. Update critical vulnerabilities only. Run tests after updates."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  weekly-test-coverage:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 2 * * 3'  # Среда

    steps:
      - name: Trigger Copilot - Test Coverage Improvement
        run: |
          gh copilot agent start --task "Analyze test coverage report in htmlcov/. Identify modules with <80% coverage. Add missing unit tests for critical paths in src/dmarket/ and src/telegram_bot/."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  weekly-documentation:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 2 * * 5'  # Пятница

    steps:
      - name: Trigger Copilot - Documentation Update
        run: |
          gh copilot agent start --task "Review docs/ for outdated information. Update API reference in docs/api_reference.md. Ensure all new functions have Google-style docstrings."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  performance-monitoring:
    runs-on: ubuntu-latest

    steps:
      - name: Trigger Copilot - Performance Analysis
        run: |
          gh copilot agent start --task "Check for performance regressions in arbitrage scanner (src/dmarket/arbitrage_scanner.py). Profile async operations. Suggest optimizations if response time >2s."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
