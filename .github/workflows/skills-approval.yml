name: Skills Approval Workflow

# Automatically validates and checks skills when they are added or modified
# Requires 2+ approvals from team members (CODEOWNERS)
# Part of Phase 3 SkillsMP implementation

"on":
  pull_request:
    paths:
      - '.github/skills/**'
      - 'src/**/SKILL_*.md'
    types: [opened, synchronize, reopened, ready_for_review]
  
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  validate-skill-changes:
    name: Validate Skill Changes
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for diff
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install pyyaml structlog
      
      - name: Run Skills Validation
        id: validation
        run: |
          python scripts/validate_skills.py
          echo "validation_status=$?" >> $GITHUB_OUTPUT
      
      - name: Run Security Scan
        id: security
        run: |
          python scripts/security_scan_skills.py > security_report.md
          echo "security_status=$?" >> $GITHUB_OUTPUT
      
      - name: Check Dependencies
        id: dependencies
        run: |
          python scripts/check_dependencies.py
          echo "dependencies_status=$?" >> $GITHUB_OUTPUT
      
      - name: Generate Skills Report
        if: always()
        run: |
          python scripts/generate_skills_report.py > skills_report.md
      
      - name: Comment PR with Results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            let comment = '## ü§ñ Skills Validation Report\n\n';
            
            // Validation status
            const validationStatus = '${{ steps.validation.outputs.validation_status }}';
            comment += validationStatus === '0' 
              ? '‚úÖ **Validation**: All skills are valid\n' 
              : '‚ùå **Validation**: Some skills have errors\n';
            
            // Security status
            const securityStatus = '${{ steps.security.outputs.security_status }}';
            comment += securityStatus === '0' 
              ? '‚úÖ **Security**: No security issues found\n' 
              : 'üî¥ **Security**: Security issues detected (see report below)\n';
            
            // Dependencies status
            const depsStatus = '${{ steps.dependencies.outputs.dependencies_status }}';
            comment += depsStatus === '0' 
              ? '‚úÖ **Dependencies**: No circular dependencies\n' 
              : '‚ö†Ô∏è **Dependencies**: Circular dependencies detected\n';
            
            // Add security report if exists
            try {
              const securityReport = fs.readFileSync('security_report.md', 'utf8');
              comment += '\n---\n\n' + securityReport;
            } catch (e) {
              console.log('No security report found');
            }
            
            // Add skills report if exists
            try {
              const skillsReport = fs.readFileSync('skills_report.md', 'utf8');
              comment += '\n---\n\n' + skillsReport;
            } catch (e) {
              console.log('No skills report found');
            }
            
            // Required approvals notice
            comment += '\n---\n\n';
            comment += '### ‚ö†Ô∏è Approval Required\n\n';
            comment += 'This PR requires **2+ approvals** from team members listed in `.github/skills/CODEOWNERS`.\n\n';
            comment += '- [ ] Validation passed\n';
            comment += '- [ ] Security scan passed\n';
            comment += '- [ ] Dependencies check passed\n';
            comment += '- [ ] 2+ team members approved\n';
            
            // Post comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: comment
            });
      
      - name: Check if all validations passed
        if: always()
        run: |
          if [ "${{ steps.validation.outputs.validation_status }}" != "0" ]; then
            echo "‚ùå Validation failed"
            exit 1
          fi
          
          if [ "${{ steps.security.outputs.security_status }}" != "0" ]; then
            echo "‚ùå Security scan failed"
            exit 1
          fi
          
          if [ "${{ steps.dependencies.outputs.dependencies_status }}" != "0" ]; then
            echo "‚ö†Ô∏è Dependencies check failed (warning only)"
          fi
          
          echo "‚úÖ All required checks passed!"
  
  check-lifecycle-status:
    name: Check Lifecycle Status
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: validate-skill-changes
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Check Skill Status
        run: |
          python3 << 'EOF'
          import yaml
          import sys
          from pathlib import Path
          
          # Find modified SKILL.md files
          skill_files = list(Path(".github/skills").rglob("SKILL.md"))
          skill_files.extend(Path("src").rglob("SKILL_*.md"))
          
          draft_skills = []
          in_review_skills = []
          approved_skills = []
          
          for skill_file in skill_files:
              content = skill_file.read_text()
              if content.startswith("---"):
                  parts = content.split("---", 2)
                  if len(parts) >= 3:
                      frontmatter = yaml.safe_load(parts[1])
                      status = frontmatter.get("status", "unknown")
                      name = frontmatter.get("name", skill_file.stem)
                      
                      if status == "draft":
                          draft_skills.append(name)
                      elif status == "in-review":
                          in_review_skills.append(name)
                      elif status == "approved":
                          approved_skills.append(name)
          
          print(f"üìù Draft skills: {len(draft_skills)}")
          print(f"üîç In-review skills: {len(in_review_skills)}")
          print(f"‚úÖ Approved skills: {len(approved_skills)}")
          
          # Warn if trying to merge draft skills
          if draft_skills:
              print(f"‚ö†Ô∏è WARNING: Draft skills found: {', '.join(draft_skills)}")
              print("Update status to 'in-review' or 'approved' before merging")
              sys.exit(1)
          
          print("‚úÖ All skills have appropriate lifecycle status")
          EOF
  
  require-team-approval:
    name: Require Team Approval
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: validate-skill-changes
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Check Required Approvals
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Get PR reviews
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
            });
            
            // Count approvals
            const approvals = reviews.filter(r => r.state === 'APPROVED');
            const approvalCount = new Set(approvals.map(r => r.user.login)).size;
            
            console.log(`Found ${approvalCount} unique approvals`);
            
            // Check if PR author is trying to approve their own PR
            const prAuthor = context.payload.pull_request.user.login;
            const selfApproval = approvals.some(r => r.user.login === prAuthor);
            
            if (selfApproval) {
              core.warning('Self-approval detected - does not count toward required approvals');
            }
            
            // Require 2+ approvals (excluding self-approval)
            const requiredApprovals = 2;
            const validApprovals = approvalCount - (selfApproval ? 1 : 0);
            
            if (validApprovals < requiredApprovals) {
              core.setFailed(`‚ùå Insufficient approvals: ${validApprovals}/${requiredApprovals} required`);
              
              // Comment on PR
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: `‚ö†Ô∏è This PR requires **${requiredApprovals} approvals** from team members listed in \`.github/skills/CODEOWNERS\`.\n\nCurrent approvals: **${validApprovals}/${requiredApprovals}**\n\n*Self-approvals do not count.*`
              });
            } else {
              console.log(`‚úÖ Sufficient approvals: ${validApprovals}/${requiredApprovals}`);
            }
