name: Copilot Agent

"on":
  issues:
    types: [labeled]
  issue_comment:
    types: [created]

concurrency:
  group: copilot-agent-${{ github.event.issue.number || github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  agent:
    name: Run Copilot Agent
    # Trigger on 'copilot-agent' label OR @copilot mention in comments
    if: |
      (github.event_name == 'issues' && contains(github.event.label.name, 'copilot-agent')) ||
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@copilot'))
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -e .

      - name: Setup environment
        run: |
          echo "PYTHONPATH=${{ github.workspace }}/src" >> $GITHUB_ENV
          echo "PYTHONUNBUFFERED=1" >> $GITHUB_ENV
          echo "DRY_RUN=true" >> $GITHUB_ENV

      - name: Extract task from issue
        id: extract_task
        uses: actions/github-script@v7
        with:
          script: |
            let task = '';
            if (context.eventName === 'issue_comment') {
              // Extract task from comment (after @copilot mention)
              const body = context.payload.comment.body || '';
              const match = body.match(/@copilot\s+(.+)/i);
              task = match ? match[1].trim() : 'No task specified';
            } else {
              // Use issue title and body
              const title = context.payload.issue?.title || '';
              const body = context.payload.issue?.body || '';
              task = `${title}: ${body.substring(0, 500)}`;
            }
            // Sanitize task - remove potentially dangerous characters
            task = task.replace(/[`$\\]/g, '').substring(0, 1000);
            core.setOutput('task', task);
            console.log(`Task: ${task}`);

      - name: Run Copilot Agent CLI
        id: agent
        env:
          AGENT_TASK: ${{ steps.extract_task.outputs.task }}
        run: |
          echo "ðŸ¤– Running Copilot Agent..."
          echo "Task: $AGENT_TASK"

          # Run the agent in dry-run mode for safety
          # Use environment variable to prevent command injection
          python -m src.cli.copilot_cli do "$AGENT_TASK" --dry-run > agent_output.txt 2>&1 || true

          # Check if changes were made
          if git diff --quiet; then
            echo "changes_made=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          else
            echo "changes_made=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
          fi

          # Output agent response
          cat agent_output.txt
          echo "output<<EOF" >> $GITHUB_OUTPUT
          cat agent_output.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment on issue with results
        uses: actions/github-script@v7
        with:
          script: |
            const output = `${{ steps.agent.outputs.output }}`;
            const changesMade = '${{ steps.agent.outputs.changes_made }}' === 'true';

            let body = `## ðŸ¤– Copilot Agent Results\n\n`;
            body += `### Task\n\`\`\`\n${{ steps.extract_task.outputs.task }}\n\`\`\`\n\n`;
            body += `### Output\n\`\`\`\n${output}\n\`\`\`\n\n`;

            if (changesMade) {
              body += `### Changes Made\nâœ… Changes were made to the repository.\n`;
              body += `A PR will be created shortly.\n`;
            } else {
              body += `### No Changes\nâš ï¸ No code changes were made.\n`;
              body += `This may be expected for analysis or dry-run tasks.\n`;
            }

            body += `\n---\n*Automated by GitHub Copilot Agent*`;

            const issueNumber = context.issue?.number || context.payload.issue?.number;
            if (issueNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: body
              });
            }

      - name: Create branch and commit changes
        if: steps.agent.outputs.changes_made == 'true'
        run: |
          BRANCH_NAME="copilot/issue-${{ github.event.issue.number }}-$(date +%s)"
          git checkout -b $BRANCH_NAME
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "fix: Address issue #${{ github.event.issue.number }}

          Automated changes by Copilot Agent.

          Closes #${{ github.event.issue.number }}"
          git push origin $BRANCH_NAME
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Create Pull Request
        if: steps.agent.outputs.changes_made == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `fix: Address issue #${{ github.event.issue.number }} - ${{ github.event.issue.title }}`,
              body: `## Summary\n\nAutomated fix for #${{ github.event.issue.number }}.\n\n### Changes\n\nSee commit history for details.\n\n---\n*Created by Copilot Agent*`,
              head: process.env.branch_name,
              base: 'main'
            });

            console.log(`PR created: ${pr.html_url}`);

            // Comment on the issue with PR link
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.issue.number }},
              body: `ðŸŽ‰ PR created: ${pr.html_url}\n\nPlease review the changes.`
            });

  security-check:
    name: Security Check for Agent Changes
    needs: agent
    if: needs.agent.outputs.changes_made == 'true'
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install security tools
        run: |
          pip install bandit safety pip-audit

      - name: Run Bandit security scan
        run: |
          bandit -r src/ -ll --format json -o bandit-report.json || true
          cat bandit-report.json

      - name: Run Safety check
        run: |
          safety check --json > safety-report.json || true
          cat safety-report.json

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json
