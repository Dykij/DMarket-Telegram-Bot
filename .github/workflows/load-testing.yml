# Load Testing Workflow with Locust
# Tests API performance under load
name: Load Testing

"on":
  workflow_dispatch:
    inputs:
      users:
        description: 'Number of concurrent users'
        required: false
        default: '10'
      spawn_rate:
        description: 'Users spawned per second'
        required: false
        default: '2'
      run_time:
        description: 'Test duration (e.g., 30s, 1m, 5m)'
        required: false
        default: '30s'

env:
  PYTHON_VERSION: "3.11"
  PYTHONPATH: ${{ github.workspace }}/src

jobs:
  load-test:
    name: Run Load Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e ".[dev]"
          pip install locust

      - name: Create locustfile if not exists
        run: |
          if [ ! -f tests/load/locustfile.py ]; then
            mkdir -p tests/load
            cat > tests/load/locustfile.py << 'EOF'
          """Load testing with Locust.

          Run locally:
              locust -f tests/load/locustfile.py --headless -u 10 -r 2 -t 30s
          """

          from locust import HttpUser, task, between


          class APIUser(HttpUser):
              """Simulates API user behavior."""

              wait_time = between(1, 3)

              @task(3)
              def health_check(self):
                  """Check API health."""
                  self.client.get("/health")

              @task(2)
              def get_items(self):
                  """Fetch market items."""
                  self.client.get("/api/items?limit=10")

              @task(1)
              def get_balance(self):
                  """Check balance."""
                  self.client.get("/api/balance")
          EOF
          fi

      - name: Run load tests
        run: |
          echo "## Load Testing Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Configuration:" >> $GITHUB_STEP_SUMMARY
          echo "- Users: ${{ github.event.inputs.users || '10' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Spawn Rate: ${{ github.event.inputs.spawn_rate || '2' }}/s" >> $GITHUB_STEP_SUMMARY
          echo "- Duration: ${{ github.event.inputs.run_time || '30s' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Note: This requires a running server
          echo "⚠️ Load tests require a running API server" >> $GITHUB_STEP_SUMMARY
          echo "Run manually with: locust -f tests/load/locustfile.py" >> $GITHUB_STEP_SUMMARY
