name: CI (Simplified)

# Ð£Ð¿Ñ€Ð¾Ñ‰ÐµÐ½Ð½Ñ‹Ð¹ Ð¸ Ð½Ð°Ð´ÐµÐ¶Ð½Ñ‹Ð¹ CI workflow
on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.11"
  # Ð’ÐµÑ€ÑÐ¸Ð¸ Ð´Ð»Ñ Ð¿Ð°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ð¾Ð¹ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚Ð¸
  PYTHON_VERSIONS: "3.10, 3.11, 3.12"
  # ÐšÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
  CACHE_VERSION: v1
  PIP_CACHE_DIR: ~/.cache/pip

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: write

jobs:
  lint-and-format:
    name: Lint and Format Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            pyproject.toml

      - name: Cache linting tools
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-lint-${{ env.CACHE_VERSION }}-${{ hashFiles('requirements.txt', 'pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-lint-${{ env.CACHE_VERSION }}-
            ${{ runner.os }}-lint-

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy
          # Try to install project dependencies, but don't fail if it errors
          pip install -r requirements.txt || echo "::warning::ÐÐµÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"

      - name: Run Ruff linting
        run: |
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
          DIRS=""
          [ -d "src" ] && DIRS="$DIRS src"
          [ -d "tests" ] && DIRS="$DIRS tests"
          [ -d "scripts" ] && DIRS="$DIRS scripts"

          if [ -n "$DIRS" ]; then
            echo "Checking directories: $DIRS"
            ruff check $DIRS --output-format=github
          else
            echo "::warning::ÐÐµÑ‚ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸"
          fi
        continue-on-error: false  # Ð¤ÐµÐ¹Ð»Ð¸Ð¼ Ð¿Ñ€Ð¸ Ð¾Ð±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð¸Ð¸ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼

      - name: Run Ruff format check
        run: |
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
          DIRS=""
          [ -d "src" ] && DIRS="$DIRS src"
          [ -d "tests" ] && DIRS="$DIRS tests"
          [ -d "scripts" ] && DIRS="$DIRS scripts"

          if [ -n "$DIRS" ]; then
            echo "Checking format for directories: $DIRS"
            ruff format --check $DIRS
          fi
        continue-on-error: false  # Ð¤ÐµÐ¹Ð»Ð¸Ð¼ ÐµÑÐ»Ð¸ Ñ‚Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ

      - name: Run MyPy type checking
        run: |
          mypy src --install-types --non-interactive --ignore-missing-imports
        continue-on-error: true  # ÐžÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ true Ñ‚.Ðº. mypy Ð¼Ð¾Ð¶ÐµÑ‚ Ð¸Ð¼ÐµÑ‚ÑŒ Ð»Ð¾Ð¶Ð½Ñ‹Ðµ ÑÑ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ

  test:
    name: Run Tests
    runs-on: ${{ matrix.os }}
    needs: lint-and-format
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        python-version: ["3.10", "3.11", "3.12"]
        include:
          - os: ubuntu-latest
            python-version: "3.11"
            coverage: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            pyproject.toml

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ env.CACHE_VERSION }}-py${{ matrix.python-version }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ env.CACHE_VERSION }}-py${{ matrix.python-version }}-
            ${{ runner.os }}-pip-${{ env.CACHE_VERSION }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip

          # Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
          pip install pytest pytest-asyncio pytest-cov pytest-mock

          # Ð—Ð°Ñ‚ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt || echo "::warning::ÐÐµÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"
          else
            echo "::warning::requirements.txt Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½"
          fi

      - name: Create test environment
        run: |
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¾Ð²
          if [ -f .env.example ]; then
            cp .env.example .env
          else
            echo "TELEGRAM_BOT_TOKEN=test_token" > .env
            echo "DMARKET_PUBLIC_KEY=test_key" >> .env
            echo "DMARKET_SECRET_KEY=test_secret" >> .env
            echo "DATABASE_URL=sqlite:///test.db" >> .env
            echo "TESTING=true" >> .env
          fi

      - name: Run tests (with coverage for Python 3.11)
        if: matrix.coverage
        run: |
          # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ PYTHONPATH
          export PYTHONPATH=$GITHUB_WORKSPACE:$PYTHONPATH

          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ñ‚ÐµÑÑ‚Ð¾Ð²
          if [ ! -d "tests" ] || [ -z "$(find tests -name 'test_*.py' -o -name '*_test.py' 2>/dev/null)" ]; then
            echo "::warning::Ð¢ÐµÑÑ‚Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹, ÑÑ‡Ð¸Ñ‚Ð°ÐµÐ¼ workflow ÑƒÑÐ¿ÐµÑˆÐ½Ñ‹Ð¼"
            exit 0
          fi

          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ‚ÐµÑÑ‚Ñ‹ Ñ Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸ÐµÐ¼ Ð¸ Ð¿Ð°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ð¾ (pytest-xdist)
          pytest tests/ \
            --cov=src \
            --cov-report=xml \
            --cov-report=term \
            --cov-report=html \
            --maxfail=10 \
            -v \
            -n auto \
            -k "not integration and not slow" \
            --tb=short \
            || { echo "::warning::ÐÐµÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ñ‹ Ð¿Ñ€Ð¾Ð²Ð°Ð»Ð¸Ð»Ð¸ÑÑŒ, Ð½Ð¾ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð°ÐµÐ¼"; exit 0; }
        continue-on-error: false
        env:
          PYTHONPATH: ${{ github.workspace }}

      - name: Run tests (without coverage for other Python versions)
        if: ${{ !matrix.coverage }}
        run: |
          # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ PYTHONPATH
          export PYTHONPATH=$GITHUB_WORKSPACE:$PYTHONPATH

          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ñ‚ÐµÑÑ‚Ð¾Ð²
          if [ ! -d "tests" ] || [ -z "$(find tests -name 'test_*.py' -o -name '*_test.py' 2>/dev/null)" ]; then
            echo "::warning::Ð¢ÐµÑÑ‚Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹, ÑÑ‡Ð¸Ñ‚Ð°ÐµÐ¼ workflow ÑƒÑÐ¿ÐµÑˆÐ½Ñ‹Ð¼"
            exit 0
          fi

          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ‚ÐµÑÑ‚Ñ‹ Ð¿Ð°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ð¾ Ð±ÐµÐ· Ð¿Ð¾ÐºÑ€Ñ‹Ñ‚Ð¸Ñ (Ð±Ñ‹ÑÑ‚Ñ€ÐµÐµ)
          pytest tests/ \
            --maxfail=10 \
            -v \
            -n auto \
            -k "not integration and not slow" \
            --tb=short \
            || { echo "::warning::ÐÐµÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ñ‹ Ð¿Ñ€Ð¾Ð²Ð°Ð»Ð¸Ð»Ð¸ÑÑŒ, Ð½Ð¾ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð°ÐµÐ¼"; exit 0; }
        continue-on-error: false
        env:
          PYTHONPATH: ${{ github.workspace }}

      - name: Upload coverage report
        if: matrix.coverage && always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-py${{ matrix.python-version }}
          path: |
            coverage.xml
            .coverage
            htmlcov/
          retention-days: 7
        continue-on-error: true

      - name: Check coverage (non-blocking)
        if: matrix.coverage && always()
        run: |
          if command -v coverage &> /dev/null; then
            coverage report --fail-under=80 || echo "::warning::ÐŸÐ¾ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ Ð½Ð¸Ð¶Ðµ 80%"
          fi
        continue-on-error: true

  security-basic:
    name: Basic Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Cache security tools
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-security-${{ env.CACHE_VERSION }}
          restore-keys: |
            ${{ runner.os }}-security-

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety pip-audit

      - name: Bandit Security Scan
        run: |
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð¾Ð²
          mkdir -p security-reports

          # Ð¡ÐºÐ°Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
          if [ -d "src" ]; then
            bandit -r src/ -f json -o security-reports/bandit-report.json || echo "::warning::Bandit Ð¾Ð±Ð½Ð°Ñ€ÑƒÐ¶Ð¸Ð» Ð¿Ð¾Ñ‚ÐµÐ½Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸"
          else
            echo "::warning::Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ src/ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°, Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Bandit scan"
          fi
        continue-on-error: true

      - name: Safety Check
        run: |
          safety check --json || echo "::warning::Safety Ð¾Ð±Ð½Ð°Ñ€ÑƒÐ¶Ð¸Ð» ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÑÑ…"
        continue-on-error: false

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: security-reports/
          retention-days: 7
        continue-on-error: true

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [lint-and-format, test, security-basic]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "# ðŸ¤– CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint & Format | ${{ needs.lint-and-format.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result == 'success' && 'âœ… Passed' || 'âš ï¸ Check logs' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security-basic.result == 'success' && 'âœ… Passed' || 'âš ï¸ Check logs' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
