name: Code Quality

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:  # Allow manual triggering

# Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð°Ñ€Ð°Ð»Ð»ÐµÐ»Ð¸Ð·Ð¼Ð¾Ð¼ Ð´Ð»Ñ Ð¿Ñ€ÐµÐ´Ð¾Ñ‚Ð²Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ñ Ð¾Ð´Ð½Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð²
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# ÐžÐ³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð°Ð² Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° GITHUB_TOKEN
permissions:
  contents: read
  checks: write  # Ð”Ð»Ñ Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ð¸ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð² Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¾Ðº

env:
  PYTHON_VERSION: '3.11'
  CACHE_VERSION: v1
  PIP_CACHE_DIR: ~/.cache/pip

jobs:
  lint:
    name: Linting and Type Checking
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          echo "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð´Ð»Ñ Ð»Ð¸Ð½Ñ‚Ð¸Ð½Ð³Ð°..."
          python -m pip install --upgrade pip

          # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð² Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ ÐºÐ¾Ð´Ð°
          pip install ruff mypy

          # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° (Ð½ÐµÐ¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾, Ð½Ð¾ Ð¿Ð¾Ð»ÐµÐ·Ð½Ð¾ Ð´Ð»Ñ MyPy)
          if [ -f requirements.txt ]; then
            echo "âœ… Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¸Ð· requirements.txt..."
            pip install -r requirements.txt || echo "::warning::ÐÐµÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¸Ð· requirements.txt Ð½Ðµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ"
          elif [ -f pyproject.toml ]; then
            echo "âœ… Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¸Ð· pyproject.toml..."
            pip install -e . || echo "::warning::ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐµ Ð¸Ð· pyproject.toml"
          fi

          echo "âœ… Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð´Ð»Ñ Ð»Ð¸Ð½Ñ‚Ð¸Ð½Ð³Ð° ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"

      - name: Run Ruff Format Check
        run: |
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ Ruff..."

          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
          DIRS=""
          [ -d "src" ] && DIRS="$DIRS src"
          [ -d "tests" ] && DIRS="$DIRS tests"
          [ -d "scripts" ] && DIRS="$DIRS scripts"

          if [ -n "$DIRS" ]; then
            ruff format --check $DIRS || echo "::warning::Ruff format Ð²Ñ‹ÑÐ²Ð¸Ð» Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ"
          else
            echo "::warning::ÐÐµÑ‚ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸"
          fi
        continue-on-error: true

      - name: Run Ruff Linting
        run: |
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð¸Ð»Ñ ÐºÐ¾Ð´Ð° Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ Ruff..."

          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
          DIRS=""
          [ -d "src" ] && DIRS="$DIRS src"
          [ -d "tests" ] && DIRS="$DIRS tests"
          [ -d "scripts" ] && DIRS="$DIRS scripts"

          if [ -n "$DIRS" ]; then
            ruff check $DIRS --output-format=github || echo "::warning::Ruff check Ð²Ñ‹ÑÐ²Ð¸Ð» Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ ÑÑ‚Ð¸Ð»Ñ ÐºÐ¾Ð´Ð°"
          fi
        continue-on-error: true

      - name: Run MyPy
        run: |
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‚Ð¸Ð¿Ð¾Ð² Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ MyPy..."
          mypy src --config-file=pyproject.toml --install-types --non-interactive || echo "::warning::MyPy Ð²Ñ‹ÑÐ²Ð¸Ð» Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ñ Ñ‚Ð¸Ð¿Ð°Ð¼Ð¸"
        continue-on-error: true  # Type checking can have false positives

      - name: Generate code quality report
        if: always()
        run: |
          echo "Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð° Ð¾ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ðµ ÐºÐ¾Ð´Ð°..."
          mkdir -p reports

          ruff format --check src tests scripts > reports/ruff-format-report.txt 2>&1 || true
          ruff check src tests scripts > reports/ruff-check-report.txt 2>&1 || true
          mypy src --config-file=pyproject.toml --install-types --non-interactive > reports/mypy-report.txt 2>&1 || true

          echo "âœ… ÐžÑ‚Ñ‡ÐµÑ‚Ñ‹ Ð¾ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ðµ ÐºÐ¾Ð´Ð° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ñ‹"
        continue-on-error: true

      - name: Upload code quality report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-quality-reports
          path: reports/
          retention-days: 7

  security:
    name: Security Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies and security tools
        run: |
          echo "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð¸ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð² Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸..."
          python -m pip install --upgrade pip

          # Install project dependencies
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

          # Install security tools
          pip install safety bandit[toml] pip-audit
          echo "âœ… Ð˜Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"

      - name: Check dependencies with Safety
        run: |
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð½Ð° ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ Safety..."

          if [ -f requirements.txt ]; then
            safety check -r requirements.txt || echo "::warning::Safety Ð¾Ð±Ð½Ð°Ñ€ÑƒÐ¶Ð¸Ð» ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÑÑ…"
          elif [ -f poetry.lock ]; then
            pip install poetry
            poetry export -f requirements.txt --output requirements-export.txt
            safety check -r requirements-export.txt || echo "::warning::Safety Ð¾Ð±Ð½Ð°Ñ€ÑƒÐ¶Ð¸Ð» ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÑÑ…"
          else
            echo "::warning::ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹ Ñ„Ð°Ð¹Ð»Ñ‹ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸"
          fi

      - name: Scan code with Bandit
        run: |
          echo "Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÐºÐ¾Ð´Ð° Ð½Ð° ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ Bandit..."
          bandit -r ./src || echo "::warning::Bandit Ð¾Ð±Ð½Ð°Ñ€ÑƒÐ¶Ð¸Ð» Ð¿Ð¾Ñ‚ÐµÐ½Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ðµ ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð² ÐºÐ¾Ð´Ðµ"

      - name: Generate security report
        if: always()
        run: |
          echo "Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð° Ð¾ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸..."

          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð¾Ð²
          mkdir -p security-reports

          # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¾Ðº
          if [ -f requirements.txt ]; then
            safety check -r requirements.txt --json > security-reports/safety-report.json 2>&1 || true
          elif [ -f poetry.lock ]; then
            pip install poetry
            poetry export -f requirements.txt --output requirements-export.txt
            safety check -r requirements-export.txt --json > security-reports/safety-report.json 2>&1 || true
          fi

          bandit -r ./src -f json -o security-reports/bandit-report.json || true

          echo "âœ… ÐžÑ‚Ñ‡ÐµÑ‚Ñ‹ Ð¾ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ñ‹"

      - name: Upload security report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: security-reports/
          retention-days: 7

  docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Check docs structure
        id: check-docs
        run: |
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ð¸..."

          if [ -d "docs/source" ] && [ -f "docs/source/conf.py" ]; then
            echo "has_sphinx=true" >> $GITHUB_OUTPUT
            echo "âœ… ÐÐ°Ð¹Ð´ÐµÐ½Ð° Sphinx Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ"
          else
            echo "has_sphinx=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Sphinx Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Markdown"
          fi

      - name: Install dependencies for Sphinx
        if: steps.check-docs.outputs.has_sphinx == 'true'
        run: |
          echo "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð´Ð»Ñ Sphinx..."
          python -m pip install --upgrade pip
          pip install sphinx sphinx-rtd-theme sphinx-autodoc-typehints

          # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° Ð´Ð»Ñ autodoc
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt || echo "::warning::ÐÐµÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹"
          fi

      - name: Build Sphinx documentation
        if: steps.check-docs.outputs.has_sphinx == 'true'
        run: |
          echo "Ð¡Ð±Ð¾Ñ€ÐºÐ° Sphinx Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ð¸..."
          cd docs
          python -m sphinx.cmd.build -b html source build/html || {
            echo "::warning::ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑÐ±Ð¾Ñ€ÐºÐµ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ð¸"
            exit 0
          }
          echo "âœ… Sphinx Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ ÑÐ¾Ð±Ñ€Ð°Ð½Ð°"
        continue-on-error: true

      - name: Create docs summary
        if: always()
        run: |
          echo "# ðŸ“š Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check-docs.outputs.has_sphinx }}" == "true" ]; then
            echo "- **Ð¢Ð¸Ð¿**: Sphinx HTML" >> $GITHUB_STEP_SUMMARY
            if [ -d "docs/build/html" ]; then
              echo "- **Ð¡Ñ‚Ð°Ñ‚ÑƒÑ**: âœ… Ð¡Ð¾Ð±Ñ€Ð°Ð½Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **Ð¡Ñ‚Ð°Ñ‚ÑƒÑ**: âš ï¸ ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ±Ð¾Ñ€ÐºÐ¸" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- **Ð¢Ð¸Ð¿**: Markdown" >> $GITHUB_STEP_SUMMARY
            echo "- **Ð Ð°ÑÐ¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ**: \`docs/*.md\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Ð¡Ñ‚Ð°Ñ‚ÑƒÑ**: âœ… Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Sphinx documentation
        if: steps.check-docs.outputs.has_sphinx == 'true' && hashFiles('docs/build/html/**') != ''
        uses: actions/upload-artifact@v4
        with:
          name: sphinx-documentation
          path: docs/build/html
          retention-days: 7
        continue-on-error: true
