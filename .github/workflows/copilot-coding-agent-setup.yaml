name: Copilot Coding Agent Setup
"on":
  workflow_call:

jobs:
  setup:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Full history for better context

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install ruff mypy black pytest pytest-asyncio pytest-cov

      - name: Cache .mypy_cache
        uses: actions/cache@v5
        with:
          path: .mypy_cache
          key: mypy-${{ runner.os }}-${{ hashFiles('pyproject.toml') }}

      - name: Cache .ruff_cache
        uses: actions/cache@v5
        with:
          path: .ruff_cache
          key: ruff-${{ runner.os }}-${{ hashFiles('pyproject.toml') }}

      - name: Cache .pytest_cache
        uses: actions/cache@v5
        with:
          path: .pytest_cache
          key: pytest-${{ runner.os }}-${{ hashFiles('pyproject.toml') }}

      - name: Install project in editable mode
        run: pip install -e .

      - name: Verify async dependencies
        run: |
          python -c "import asyncio; print('✓ asyncio available')"
          python -c "import httpx; print('✓ httpx available')"
          python -c "import telegram; print('✓ python-telegram-bot available')"

      - name: Setup environment variables
        run: |
          echo "PYTHONPATH=${{ github.workspace }}/src" >> $GITHUB_ENV
          echo "PYTHONUNBUFFERED=1" >> $GITHUB_ENV
          echo "PYTEST_ASYNCIO_MODE=auto" >> $GITHUB_ENV

      - name: Display environment info
        run: |
          echo "✓ Python $(python --version)"
          echo "✓ Ruff $(ruff --version)"
          echo "✓ MyPy $(mypy --version)"
          echo "✓ Pytest $(pytest --version)"
          echo "✓ Environment ready for Copilot Coding Agent"
