# GitHub Actions workflow –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ Skills
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç SKILL.md —Ñ–∞–π–ª—ã –∏ marketplace.json –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö

name: "üîç Skill Validation"

"on":
  push:
    paths:
      - 'src/**/SKILL_*.md'
      - 'src/**/marketplace.json'
      - '.vscode/skills.json'
      - '.github/workflows/skill-validation.yml'
  pull_request:
    paths:
      - 'src/**/SKILL_*.md'
      - 'src/**/marketplace.json'
      - '.vscode/skills.json'
  workflow_dispatch:

concurrency:
  group: skill-validation-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate-skills:
    name: "Validate Skills Format"
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: "üì• Checkout repository"
        uses: actions/checkout@v6

      - name: "üêç Setup Python 3.12"
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: "üì¶ Install validation dependencies"
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml jsonschema markdown

      - name: "üîç Validate SKILL.md files (YAML frontmatter)"
        run: |
          python3 << 'EOF'
          import os
          import yaml
          import sys
          from pathlib import Path

          print("üîç Validating SKILL.md files...")
          errors = []
          skill_files = list(Path('src').rglob('SKILL_*.md'))
          
          if not skill_files:
              print("‚ö†Ô∏è No SKILL.md files found")
              sys.exit(0)
          
          required_fields = [
              'name', 'description', 'version', 'author', 'license',
              'category', 'status', 'main_module', 'dependencies'
          ]
          
          for skill_file in skill_files:
              print(f"\nüìÑ Checking: {skill_file}")
              
              with open(skill_file, 'r', encoding='utf-8') as f:
                  content = f.read()
              
              # Extract YAML frontmatter
              if not content.startswith('---'):
                  errors.append(f"{skill_file}: Missing YAML frontmatter")
                  continue
              
              try:
                  parts = content.split('---', 2)
                  if len(parts) < 3:
                      errors.append(f"{skill_file}: Invalid YAML frontmatter format")
                      continue
                  
                  frontmatter = yaml.safe_load(parts[1])
                  
                  # Validate required fields
                  missing = [f for f in required_fields if f not in frontmatter]
                  if missing:
                      errors.append(f"{skill_file}: Missing fields: {', '.join(missing)}")
                  
                  # Validate version format
                  version = frontmatter.get('version', '')
                  if not version or not all(p.isdigit() for p in version.split('.')):
                      errors.append(f"{skill_file}: Invalid version format: {version}")
                  
                  # Validate status
                  valid_statuses = ['active', 'deprecated', 'documentation-only', 'experimental']
                  if frontmatter.get('status') not in valid_statuses:
                      errors.append(f"{skill_file}: Invalid status (must be: {', '.join(valid_statuses)})")
                  
                  print(f"   ‚úÖ {frontmatter['name']} v{frontmatter['version']} - {frontmatter['status']}")
                  
              except yaml.YAMLError as e:
                  errors.append(f"{skill_file}: YAML parsing error: {str(e)}")
              except Exception as e:
                  errors.append(f"{skill_file}: Validation error: {str(e)}")
          
          if errors:
              print("\n‚ùå Validation errors found:")
              for error in errors:
                  print(f"   - {error}")
              sys.exit(1)
          else:
              print(f"\n‚úÖ All {len(skill_files)} SKILL.md files are valid!")
          EOF

      - name: "üîç Validate marketplace.json files"
        run: |
          python3 << 'EOF'
          import json
          import sys
          from pathlib import Path

          print("\nüîç Validating marketplace.json files...")
          errors = []
          marketplace_files = list(Path('src').rglob('marketplace.json'))
          
          if not marketplace_files:
              print("‚ö†Ô∏è No marketplace.json files found")
              sys.exit(0)
          
          required_fields = [
              'name', 'version', 'description', 'category',
              'skill_file', 'main_module', 'repository', 'author'
          ]
          
          for marketplace_file in marketplace_files:
              print(f"\nüìÑ Checking: {marketplace_file}")
              
              try:
                  with open(marketplace_file, 'r', encoding='utf-8') as f:
                      data = json.load(f)
                  
                  # Validate required fields
                  missing = [f for f in required_fields if f not in data]
                  if missing:
                      errors.append(f"{marketplace_file}: Missing fields: {', '.join(missing)}")
                  
                  # Validate JSON structure
                  if 'requirements' in data and 'dependencies' not in data['requirements']:
                      errors.append(f"{marketplace_file}: Missing requirements.dependencies")
                  
                  print(f"   ‚úÖ {data.get('name', 'Unknown')} v{data.get('version', '?')}")
                  
              except json.JSONDecodeError as e:
                  errors.append(f"{marketplace_file}: JSON parsing error: {str(e)}")
              except Exception as e:
                  errors.append(f"{marketplace_file}: Validation error: {str(e)}")
          
          if errors:
              print("\n‚ùå Validation errors found:")
              for error in errors:
                  print(f"   - {error}")
              sys.exit(1)
          else:
              print(f"\n‚úÖ All {len(marketplace_files)} marketplace.json files are valid!")
          EOF

      - name: "üîç Validate .vscode/skills.json"
        if: always()
        run: |
          python3 << 'EOF'
          import json
          import sys
          from pathlib import Path

          print("\nüîç Validating .vscode/skills.json...")
          
          skills_json = Path('.vscode/skills.json')
          if not skills_json.exists():
              print("‚ö†Ô∏è .vscode/skills.json not found (optional)")
              sys.exit(0)
          
          try:
              with open(skills_json, 'r', encoding='utf-8') as f:
                  data = json.load(f)
              
              # Validate structure
              required_keys = ['workspace', 'discovery', 'skills']
              missing = [k for k in required_keys if k not in data]
              
              if missing:
                  print(f"‚ùå Missing keys: {', '.join(missing)}")
                  sys.exit(1)
              
              # Count skills
              skills = data.get('skills', [])
              active_skills = [s for s in skills if s.get('status') == 'active']
              
              print(f"   ‚úÖ Skills configuration valid")
              print(f"   üìä Total skills: {len(skills)}")
              print(f"   ‚úì  Active skills: {len(active_skills)}")
              
          except json.JSONDecodeError as e:
              print(f"‚ùå JSON parsing error: {str(e)}")
              sys.exit(1)
          except Exception as e:
              print(f"‚ùå Validation error: {str(e)}")
              sys.exit(1)
          EOF

      - name: "üìä Generate Skills Report"
        if: always()
        run: |
          python3 << 'EOF'
          from pathlib import Path
          import yaml
          import json

          print("\n" + "="*60)
          print("üìä SKILLS SUMMARY REPORT")
          print("="*60)

          # Scan all SKILL.md files
          skill_files = list(Path('src').rglob('SKILL_*.md'))
          marketplace_files = list(Path('src').rglob('marketplace.json'))

          skills_data = []
          for skill_file in skill_files:
              try:
                  with open(skill_file, 'r', encoding='utf-8') as f:
                      content = f.read()
                  if content.startswith('---'):
                      parts = content.split('---', 2)
                      if len(parts) >= 3:
                          frontmatter = yaml.safe_load(parts[1])
                          skills_data.append({
                              'file': str(skill_file),
                              'name': frontmatter.get('name', 'Unknown'),
                              'version': frontmatter.get('version', '?'),
                              'status': frontmatter.get('status', '?'),
                              'category': frontmatter.get('category', '?')
                          })
              except:
                  pass

          # Print table
          if skills_data:
              print(f"\n{'Skill Name':<40} {'Version':<10} {'Status':<20} {'Category':<15}")
              print("-" * 85)
              for skill in skills_data:
                  status_emoji = "‚úÖ" if skill['status'] == 'active' else "üìù"
                  print(f"{status_emoji} {skill['name']:<38} {skill['version']:<10} {skill['status']:<20} {skill['category']:<15}")

          print(f"\nüìà Statistics:")
          print(f"   - Total SKILL.md files: {len(skill_files)}")
          print(f"   - Total marketplace.json files: {len(marketplace_files)}")
          print(f"   - Active skills: {len([s for s in skills_data if s['status'] == 'active'])}")
          print("="*60)
          EOF

      - name: "üíæ Upload validation report as artifact"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: skill-validation-report
          path: |
            src/**/SKILL_*.md
            src/**/marketplace.json
            .vscode/skills.json
          retention-days: 30

  check-skill-dependencies:
    name: "Check Skill Dependencies"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: validate-skills

    steps:
      - name: "üì• Checkout repository"
        uses: actions/checkout@v6

      - name: "üêç Setup Python 3.12"
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: "üîç Check skill module dependencies"
        run: |
          python3 << 'EOF'
          from pathlib import Path
          import ast
          import sys

          print("üîç Checking skill module dependencies...")
          
          skill_modules = {
              'src/dmarket/ai_arbitrage_predictor.py': ['src.ml.enhanced_predictor', 'src.dmarket.dmarket_api'],
              'src/telegram_bot/nlp_handler.py': ['src.telegram_bot.localization'],
              'src/analytics/ai_backtester.py': ['src.dmarket.arbitrage_scanner'],
              'src/utils/ai_threat_detector.py': ['src.utils.rate_limiter']
          }
          
          errors = []
          for module_path, expected_deps in skill_modules.items():
              if not Path(module_path).exists():
                  print(f"‚ö†Ô∏è {module_path} not found (skill not implemented yet)")
                  continue
              
              print(f"\nüìÑ Checking: {module_path}")
              
              try:
                  with open(module_path, 'r', encoding='utf-8') as f:
                      tree = ast.parse(f.read())
                  
                  imports = set()
                  for node in ast.walk(tree):
                      if isinstance(node, ast.ImportFrom):
                          if node.module:
                              imports.add(node.module)
                  
                  # Check expected dependencies
                  for dep in expected_deps:
                      dep_root = dep.split('.')[0] + '.' + dep.split('.')[1] if '.' in dep else dep
                      found = any(imp.startswith(dep_root) for imp in imports)
                      
                      if found:
                          print(f"   ‚úÖ Dependency found: {dep}")
                      else:
                          print(f"   ‚ö†Ô∏è Dependency missing: {dep}")
                  
              except Exception as e:
                  errors.append(f"{module_path}: Error parsing: {str(e)}")
          
          if errors:
              print("\n‚ùå Dependency check errors:")
              for error in errors:
                  print(f"   - {error}")
              sys.exit(1)
          else:
              print("\n‚úÖ All skill dependencies verified!")
          EOF

  notify-success:
    name: "‚úÖ Validation Complete"
    runs-on: ubuntu-latest
    needs: [validate-skills, check-skill-dependencies]
    if: success()

    steps:
      - name: "‚úÖ All validations passed"
        run: |
          echo "=================================================="
          echo "‚úÖ SKILL VALIDATION COMPLETE"
          echo "=================================================="
          echo ""
          echo "All SKILL.md files and marketplace.json validated!"
          echo "Skills are ready for use with:"
          echo "  - GitHub Copilot"
          echo "  - Claude Code"
          echo "  - ChatGPT"
          echo "  - VS Code Skills extension"
          echo ""
          echo "=================================================="
