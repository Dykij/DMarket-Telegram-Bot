# üöÄ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

## ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞!

**–î–∞—Ç–∞:** 03.01.2026
**–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 6

---

## üî¥ –ß—Ç–æ –±—ã–ª–æ –Ω–µ —Ç–∞–∫?

**–û—à–∏–±–∫–∞:** `RuntimeError: Cannot send a request, as the client has been closed`

**–ü—Ä–∏—á–∏–Ω–∞:**
–ü—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ 4 –∏–≥—Ä —Å–æ–∑–¥–∞–≤–∞–ª–æ—Å—å 4 async –∑–∞–¥–∞—á–∏. –ö–æ–≥–¥–∞ –æ–¥–Ω–∞ –∏–∑ –Ω–∏—Ö –∑–∞–≤–µ—Ä—à–∞–ª–∞—Å—å, –æ–Ω–∞ –∑–∞–∫—Ä—ã–≤–∞–ª–∞ –æ–±—â–∏–π HTTP –∫–ª–∏–µ–Ω—Ç (`await self.client.aclose()`), —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –ø–∞–¥–µ–Ω–∏—é –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á.

---

## ‚úÖ –ß—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ?

### 1. –î–æ–±–∞–≤–ª–µ–Ω —Å—á–µ—Ç—á–∏–∫ —Å—Å—ã–ª–æ–∫ (Reference Counter)

**–§–∞–π–ª:** `src/dmarket/dmarket_api.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

```python
# –í __init__:
self._client_ref_count = 0  # Reference counter
self._client_lock = asyncio.Lock()  # Thread-safe lock

# –í __aenter__:
async with self._client_lock:
    self._client_ref_count += 1
    await self._get_client()

# –í __aexit__:
async with self._client_lock:
    self._client_ref_count -= 1
    # –ó–∞–∫—Ä—ã–≤–∞–µ–º –∫–ª–∏–µ–Ω—Ç —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ —Å—á–µ—Ç—á–∏–∫ = 0
    if self._client_ref_count <= 0:
        await self._close_client()
        self._client_ref_count = 0
```

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –ö–∞–∂–¥–∞—è –∑–∞–¥–∞—á–∞ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ—Ç —Å—á–µ—Ç—á–∏–∫ –ø—Ä–∏ –≤—Ö–æ–¥–µ
- –ö–∞–∂–¥–∞—è –∑–∞–¥–∞—á–∞ –¥–µ–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É–µ—Ç —Å—á–µ—Ç—á–∏–∫ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
- –ö–ª–∏–µ–Ω—Ç –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –≤—Å–µ –∑–∞–¥–∞—á–∏ –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å

---

## üöÄ –ö–∞–∫ –≤–∫–ª—é—á–∏—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ .env —Ñ–∞–π–ª

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `.env`:

```env
# –í–∫–ª—é—á–∏—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
PARALLEL_SCANNER_ENABLED=true

# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 4)
PARALLEL_CONCURRENT_SCANS=4

# Rate limit –¥–ª—è DMarket API
MARKET_RATELIMIT=30  # –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É
```

### –°–ø–æ—Å–æ–± 2: –ß–µ—Ä–µ–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é

–í `config/config.yaml`:

```yaml
scanner:
  parallel_enabled: true
  concurrent_scans: 4
  scan_interval: 300  # 5 –º–∏–Ω—É—Ç –º–µ–∂–¥—É —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏
```

---

## ‚ö° –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

### –°–∫–æ—Ä–æ—Å—Ç—å

**–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ (4 –∏–≥—Ä—ã –ø–æ –æ—á–µ—Ä–µ–¥–∏):**
- CS:GO: 10 —Å–µ–∫
- Dota 2: 10 —Å–µ–∫
- Rust: 10 —Å–µ–∫
- TF2: 10 —Å–µ–∫
- **–ò—Ç–æ–≥–æ: ~40 —Å–µ–∫—É–Ω–¥**

**–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ (4 –∏–≥—Ä—ã –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ):**
- –í—Å–µ 4 –∏–≥—Ä—ã: 12-15 —Å–µ–∫
- **–ò—Ç–æ–≥–æ: ~15 —Å–µ–∫—É–Ω–¥** ‚ö°

**–£—Å–∫–æ—Ä–µ–Ω–∏–µ: ~2.5x –±—ã—Å—Ç—Ä–µ–µ!**

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### 1. HTTP/2 –ø–æ–¥–¥–µ—Ä–∂–∫–∞ (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!)

HTTP/2 –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º—É–ª—å—Ç–∏–ø–ª–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ - –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å–æ–≤ —á–µ—Ä–µ–∑ –æ–¥–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.

```bash
pip install httpx[http2]
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```python
# –í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
INFO - HTTP/2 support enabled
```

---

### 2. Rate Limiting

–ü—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ API —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –≤ 4 —Ä–∞–∑–∞!

**–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**

```env
# .env
MARKET_RATELIMIT=30  # 30 –∑–∞–ø—Ä–æ—Å–æ–≤/—Å–µ–∫ (max –¥–ª—è DMarket)
PARALLEL_CONCURRENT_SCANS=4  # 4 –∏–≥—Ä—ã –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
```

**–†–∞—Å—á–µ—Ç:**
- 4 –∏–≥—Ä—ã √ó 100 –ø—Ä–µ–¥–º–µ—Ç–æ–≤ = 400 –∑–∞–ø—Ä–æ—Å–æ–≤
- 400 / 30 req/sec = ~13 —Å–µ–∫—É–Ω–¥
- ‚úÖ –í –ø—Ä–µ–¥–µ–ª–∞—Ö –ª–∏–º–∏—Ç–æ–≤ DMarket

---

### 3. Connection Pool

**–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏** (—É–∂–µ –≤ –∫–æ–¥–µ):

```python
pool_limits = httpx.Limits(
    max_connections=100,      # –ú–∞–∫—Å–∏–º—É–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
    max_keepalive_connections=30,  # Keep-alive
    keepalive_expiry=60.0,    # 60 —Å–µ–∫ –∂–∏–∑–Ω–∏
)
```

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞–±–æ—Ç—ã

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞

–í –ª–æ–≥–∞—Ö –≤—ã —É–≤–∏–¥–∏—Ç–µ:

```
INFO - Starting parallel scan for 4 games
INFO - Scanning csgo (100 items)
INFO - Scanning dota2 (100 items)
INFO - Scanning rust (100 items)
INFO - Scanning tf2 (100 items)
INFO - Parallel scan completed in 14.2s ‚úÖ
```

### –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–∞—é—Ç –æ—à–∏–±–∫–∏

**429 Too Many Requests:**
```
WARNING - Rate limit hit, retrying in 5s
```

**–†–µ—à–µ–Ω–∏–µ:** –£–º–µ–Ω—å—à–∏—Ç–µ `MARKET_RATELIMIT` –¥–æ 20-25

**Timeouts:**
```
ERROR - Request timeout after 30s
```

**–†–µ—à–µ–Ω–∏–µ:** –£–≤–µ–ª–∏—á—å—Ç–µ `connection_timeout` –≤ –∫–æ–Ω—Ñ–∏–≥–µ

---

## üîß Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –í—Å–µ –µ—â–µ –æ—à–∏–±–∫–∞ "Client has been closed"

**–†–µ—à–µ–Ω–∏–µ 1:** –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ HTTP/2 —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
```bash
pip show h2
# –î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å: Version: 4.3.0
```

**–†–µ—à–µ–Ω–∏–µ 2:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—á–µ—Ç—á–∏–∫ —Å—Å—ã–ª–æ–∫
```python
# –í dmarket_api.py –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
self._client_ref_count = 0
self._client_lock = asyncio.Lock()
```

**–†–µ—à–µ–Ω–∏–µ 3:** –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞
```bash
# Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
python -m src.main
```

---

### –ü—Ä–æ–±–ª–µ–º–∞: Rate limit –æ—à–∏–±–∫–∏

**–°–∏–º–ø—Ç–æ–º:** –ß–∞—Å—Ç—ã–µ 429 –æ—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö

**–†–µ—à–µ–Ω–∏–µ:** –£–º–µ–Ω—å—à–∏—Ç–µ –Ω–∞–≥—Ä—É–∑–∫—É

```env
# –í–∞—Ä–∏–∞–Ω—Ç 1: –ú–µ–Ω—å—à–µ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π
PARALLEL_CONCURRENT_SCANS=2

# –í–∞—Ä–∏–∞–Ω—Ç 2: –£–≤–µ–ª–∏—á–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª
SCAN_INTERVAL=600  # 10 –º–∏–Ω—É—Ç –≤–º–µ—Å—Ç–æ 5
```

---

### –ü—Ä–æ–±–ª–µ–º–∞: –ú–µ–¥–ª–µ–Ω–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ

**–°–∏–º–ø—Ç–æ–º:** –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –±—ã—Å—Ç—Ä–µ–µ

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**

1. **HTTP/1.1 –≤–º–µ—Å—Ç–æ HTTP/2**
   ```bash
   pip install httpx[http2]
   ```

2. **–ù–∏–∑–∫–∏–π connection pool**
   - –£–∂–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –≤ –∫–æ–¥–µ (100 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π)

3. **–ú–µ–¥–ª–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä–Ω–µ—Ç**
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∫–æ—Ä–æ—Å—Ç—å: `speedtest-cli`

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:

1. ‚úÖ **HTTP/2** —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –∞–∫—Ç–∏–≤–µ–Ω
2. ‚úÖ **PARALLEL_SCANNER_ENABLED=true**
3. ‚úÖ **MARKET_RATELIMIT=30**
4. ‚úÖ **–ë—ã—Å—Ç—Ä—ã–π –∏–Ω—Ç–µ—Ä–Ω–µ—Ç** (>10 Mbps)
5. ‚úÖ **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è** Windows

### –î–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏:

1. ‚úÖ **Connection pool** = 100 max
2. ‚úÖ **Keep-alive** = 60 —Å–µ–∫
3. ‚úÖ **Retry logic** —Å exponential backoff
4. ‚úÖ **Circuit breaker** –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–æ–∫

---

## üìà –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

```
–ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–û:        –ü–ê–†–ê–õ–õ–ï–õ–¨–ù–û:
‚îú‚îÄ CS:GO  (10s)        ‚îå‚îÄ CS:GO  ‚îÄ‚îê
‚îú‚îÄ Dota2  (10s)        ‚îú‚îÄ Dota2  ‚îÄ‚î§ 15s ‚ö°
‚îú‚îÄ Rust   (10s)        ‚îú‚îÄ Rust   ‚îÄ‚î§
‚îî‚îÄ TF2    (10s)        ‚îî‚îÄ TF2    ‚îÄ‚îò
   ~40s total             ~15s total
```

**–£—Å–∫–æ—Ä–µ–Ω–∏–µ: 2.5x** üöÄ

### –õ–æ–≥–∏

```
INFO - Parallel Scanner Manager initialized
INFO - HTTP/2: enabled ‚úÖ
INFO - Concurrent scans: 4
INFO - Starting scan cycle...
INFO - [CS:GO] Found 23 opportunities
INFO - [Dota2] Found 15 opportunities
INFO - [Rust] Found 8 opportunities
INFO - [TF2] Found 12 opportunities
INFO - Scan completed in 14.8s ‚úÖ
```

---

## üéâ –ò—Ç–æ–≥

**–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç!**

- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –∫–ª–∏–µ–Ω—Ç–∞
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Å—á–µ—Ç—á–∏–∫ —Å—Å—ã–ª–æ–∫ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- ‚úÖ HTTP/2 –º—É–ª—å—Ç–∏–ø–ª–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ
- ‚úÖ –£—Å–∫–æ—Ä–µ–Ω–∏–µ –≤ 2.5x –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–º

**–í–∫–ª—é—á–∞–π—Ç–µ –∏ –Ω–∞—Å–ª–∞–∂–¥–∞–π—Ç–µ—Å—å!** üöÄ

---

**–í–µ—Ä—Å–∏—è:** 6.0
**–î–∞—Ç–∞:** 03.01.2026
