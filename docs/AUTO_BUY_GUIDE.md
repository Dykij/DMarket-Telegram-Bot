# Auto-Buy Feature Documentation

## üì¶ –û–±–∑–æ—Ä

–ú–æ–¥—É–ª—å –∞–≤—Ç–æ–ø–æ–∫—É–ø–∫–∏ (`auto_buyer.py`) —Ä–µ–∞–ª–∏–∑—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π –ø–æ–∫—É–ø–∫–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ (—Å–Ω–∞–π–ø–∏–Ω–≥) —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø–æ–∫—É–ø–∫–∏ –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ø–æ—Ä–æ–≥–∞ —Å–∫–∏–¥–∫–∏
- –ö–Ω–æ–ø–∫–∏ "–ö—É–ø–∏—Ç—å —Å–µ–π—á–∞—Å" –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è—Ö Telegram
- DRY_RUN —Ä–µ–∂–∏–º–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- –î–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–∫—É–ø–æ–∫

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–ø–æ–∫—É–ø–∫—É

```bash
/autobuy on
```

–≠—Ç–æ –≤–∫–ª—é—á–∏—Ç –∞–≤—Ç–æ–ø–æ–∫—É–ø–∫—É –≤ **DRY_RUN —Ä–µ–∂–∏–º–µ** (–±–µ–∑–æ–ø–∞—Å–Ω—ã–π - –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–æ–∫—É–ø–æ–∫).

### 2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

```bash
/autobuy settings
```

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:
- **–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å–∫–∏–¥–∫–∞**: 30%
- **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞**: $100
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–æ–¥–∞–∂**: ‚úÖ –í–∫–ª—é—á–µ–Ω–∞
- **–ü—Ä–æ–≤–µ—Ä–∫–∞ Trade Lock**: ‚úÖ –í–∫–ª—é—á–µ–Ω–∞

### 3. –ü–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å –∫–Ω–æ–ø–∫–æ–π "–ö—É–ø–∏—Ç—å"

–ö–æ–≥–¥–∞ –±–æ—Ç –Ω–∞–π–¥–µ—Ç –≤—ã–≥–æ–¥–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ, –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:

```
üî•üî• –ê–†–ë–ò–¢–†–ê–ñ –ù–ê–ô–î–ï–ù!

üì¶ AK-47 | Redline (Field-Tested)
üéÆ –ò–≥—Ä–∞: CSGO
üí∞ –¶–µ–Ω–∞: $18.50
üíµ –†—ã–Ω. —Ü–µ–Ω–∞: $25.00
üìä –°–∫–∏–¥–∫–∞: 26.0%
üí∏ –ü—Ä–∏–±—ã–ª—å: ~$4.55
üé® Float: 0.25
üîí Trade Lock: ‚úÖ –ù–µ—Ç

[‚úÖ –ö—É–ø–∏—Ç—å —Å–µ–π—á–∞—Å]  [‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å]
[üîç –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ DMarket]
```

–ù–∞–∂–º–∏—Ç–µ **"–ö—É–ø–∏—Ç—å —Å–µ–π—á–∞—Å"** –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π –ø–æ–∫—É–ø–∫–∏!

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –°–æ–∑–¥–∞–Ω–∏–µ AutoBuyer –≤ –∫–æ–¥–µ

```python
from src.dmarket.auto_buyer import AutoBuyer, AutoBuyConfig
from src.dmarket.dmarket_api import DMarketAPI

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å API –∫–ª–∏–µ–Ω—Ç
api_client = DMarketAPI(public_key="...", secret_key="...")

# –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–ø–æ–∫—É–ø–∫—É
config = AutoBuyConfig(
    enabled=True,
    min_discount_percent=30.0,  # –ú–∏–Ω. —Å–∫–∏–¥–∫–∞ 30%
    max_price_usd=100.0,         # –ú–∞–∫—Å. —Ü–µ–Ω–∞ $100
    check_sales_history=True,    # –ü—Ä–æ–≤–µ—Ä—è—Ç—å —Ç—Ä–µ–Ω–¥ —Ü–µ–Ω
    check_trade_lock=True,       # –ü—Ä–æ–≤–µ—Ä—è—Ç—å trade lock
    max_trade_lock_hours=168,    # –ú–∞–∫—Å. 7 –¥–Ω–µ–π lock
    dry_run=True                 # –ë–ï–ó–û–ü–ê–°–ù–´–ô –†–ï–ñ–ò–ú
)

# –°–æ–∑–¥–∞—Ç—å auto-buyer
auto_buyer = AutoBuyer(api_client, config)
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—Ä–±–∏—Ç—Ä–∞–∂–Ω–æ–π –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

```python
# –ü—Ä–µ–¥–º–µ—Ç –Ω–∞–π–¥–µ–Ω —Å–∫–∞–Ω–µ—Ä–æ–º
item = {
    "itemId": "abc123",
    "title": "AK-47 | Redline (FT)",
    "price": {"USD": 1850},  # $18.50 –≤ —Ü–µ–Ω—Ç–∞—Ö
    "suggestedPrice": {"USD": 2500},  # $25.00
    "extra": {
        "floatValue": 0.25,
        "tradeLockDuration": 0,
        "offerId": "xyz789"
    }
}

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –∫—É–ø–∏—Ç—å –µ—Å–ª–∏ –ø–æ–¥—Ö–æ–¥–∏—Ç
result = await auto_buyer.process_opportunity(item)

if result:
    if result.success:
        print(f"‚úÖ –ö—É–ø–ª–µ–Ω–æ: {result.item_title} –∑–∞ ${result.price_usd}")
    else:
        print(f"‚ùå –û—à–∏–±–∫–∞: {result.error}")
else:
    print("‚è≠Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ (–Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–¥ –∫—Ä–∏—Ç–µ—Ä–∏–∏)")
```

### –†—É—á–Ω–∞—è –ø–æ–∫—É–ø–∫–∞ (Force Buy)

```python
# –ö—É–ø–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤
result = await auto_buyer.buy_item(
    item_id="abc123",
    price_usd=18.50,
    force=True  # –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ-–ø—Ä–æ–≤–µ—Ä–∫–∏
)

print(result.message)  # "‚úÖ Purchase completed successfully"
print(result.order_id)  # "ORDER_12345"
```

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–∫—É–ø–æ–∫

```python
stats = auto_buyer.get_purchase_stats()

print(f"–í—Å–µ–≥–æ –ø–æ–∫—É–ø–æ–∫: {stats['total_purchases']}")
print(f"–£—Å–ø–µ—à–Ω—ã—Ö: {stats['successful']}")
print(f"–ù–µ—É–¥–∞—á–Ω—ã—Ö: {stats['failed']}")
print(f"–ü–æ—Ç—Ä–∞—á–µ–Ω–æ: ${stats['total_spent_usd']:.2f}")
print(f"–£—Å–ø–µ—à–Ω–æ—Å—Ç—å: {stats['success_rate']:.1f}%")
```

### –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é

```python
auto_buyer.clear_history()
```

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### DRY_RUN —Ä–µ–∂–∏–º (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è —Ç–µ—Å—Ç–æ–≤)

```python
config = AutoBuyConfig(dry_run=True)
auto_buyer = AutoBuyer(api_client, config)

# –í—Å–µ –ø–æ–∫—É–ø–∫–∏ –±—É–¥—É—Ç —Å–∏–º—É–ª–∏—Ä–æ–≤–∞—Ç—å—Å—è
result = await auto_buyer.buy_item("item123", 20.0)
# result.message = "‚úÖ DRY_RUN: Purchase simulated successfully"
# result.order_id = "DRY_RUN_item123"
```

**–í–∞–∂–Ω–æ:** –î–∞–∂–µ –≤ DRY_RUN —Ä–µ–∂–∏–º–µ –±–æ—Ç –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∞—Ä–±–∏—Ç—Ä–∞–∂–∞!

### –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏

‚ö†Ô∏è **–í–ù–ò–ú–ê–ù–ò–ï!** –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ:
1. API –∫–ª—é—á–∏ –∏–º–µ—é—Ç –ø—Ä–∞–≤–∞ –Ω–∞ –ø–æ–∫—É–ø–∫—É
2. –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ
3. –í—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–ª–∏ –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –≤ DRY_RUN

```python
config = AutoBuyConfig(
    enabled=True,
    dry_run=False,  # ‚ö†Ô∏è –†–ï–ê–õ–¨–ù–´–ï –ü–û–ö–£–ü–ö–ò
    min_discount_percent=40.0,  # –£–≤–µ–ª–∏—á–∏—Ç—å –ø–æ—Ä–æ–≥ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
)
```

---

## üéØ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –∞–≤—Ç–æ–ø–æ–∫—É–ø–∫–∏

–ü—Ä–µ–¥–º–µ—Ç –±—É–¥–µ—Ç –∫—É–ø–ª–µ–Ω **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –µ—Å–ª–∏:

1. ‚úÖ **–ê–≤—Ç–æ–ø–æ–∫—É–ø–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞** (`config.enabled = True`)
2. ‚úÖ **–°–∫–∏–¥–∫–∞ ‚â• –ø–æ—Ä–æ–≥–∞** (–Ω–∞–ø—Ä–∏–º–µ—Ä, ‚â• 30%)
3. ‚úÖ **–¶–µ–Ω–∞ ‚â§ –º–∞–∫—Å–∏–º—É–º–∞** (–Ω–∞–ø—Ä–∏–º–µ—Ä, ‚â§ $100)
4. ‚úÖ **Trade Lock –ø—Ä–∏–µ–º–ª–µ–º** (–µ—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞)
5. ‚úÖ **–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–¥–∞–∂ —Å—Ç–∞–±–∏–ª—å–Ω–∞** (–µ—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞)

### –ü—Ä–∏–º–µ—Ä –ø—Ä–æ–≤–µ—Ä–∫–∏

```python
should_buy, reason = await auto_buyer.should_auto_buy(item)

if should_buy:
    print(f"‚úÖ –ü–æ–∫—É–ø–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∞: {reason}")
    # "Discount 35.0% >= 30.0%"
else:
    print(f"‚ùå –ü—Ä–æ–ø—É—â–µ–Ω–æ: {reason}")
    # "Discount 18.0% < 30.0%"
```

---

## üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏

### –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å –∫–Ω–æ–ø–∫–æ–π

```python
from src.telegram_bot.notifications import send_arbitrage_opportunity

# –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
await send_arbitrage_opportunity(
    bot=telegram_bot,
    user_id=123456789,
    item=item_data,
    discount_percent=35.0,
    profit_usd=6.50,
    auto_buy_enabled=True  # –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–ø–æ–∫—É–ø–∫–∏
)
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "–ö—É–ø–∏—Ç—å —Å–µ–π—á–∞—Å"

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ `auto_buy_handler.py`:
```python
@callback_query_handler(pattern="^buy_now_")
async def buy_now_callback(update, context):
    # –ò–∑–≤–ª–µ—á—å item_id –∏ price
    # –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–∫—É–ø–∫—É —á–µ—Ä–µ–∑ AutoBuyer
    # –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
```

---

## üìã –ö–æ–º–∞–Ω–¥—ã Telegram

| –ö–æ–º–∞–Ω–¥–∞             | –û–ø–∏—Å–∞–Ω–∏–µ                      |
| ------------------- | ----------------------------- |
| `/autobuy`          | –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å       |
| `/autobuy on`       | –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–ø–æ–∫—É–ø–∫—É          |
| `/autobuy off`      | –í—ã–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–ø–æ–∫—É–ø–∫—É         |
| `/autobuy settings` | –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (—Å inline –∫–Ω–æ–ø–∫–∞–º–∏) |

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Unit —Ç–µ—Å—Ç—ã

```python
# tests/test_auto_buyer.py
import pytest
from src.dmarket.auto_buyer import AutoBuyer, AutoBuyConfig

@pytest.mark.asyncio
async def test_auto_buy_dry_run(mock_api_client):
    config = AutoBuyConfig(dry_run=True, enabled=True)
    buyer = AutoBuyer(mock_api_client, config)

    result = await buyer.buy_item("test123", 20.0)

    assert result.success
    assert result.order_id.startswith("DRY_RUN_")
    assert "simulated" in result.message.lower()
```

### Integration —Ç–µ—Å—Ç—ã

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã –∞–≤—Ç–æ–ø–æ–∫—É–ø–∫–∏
pytest tests/integration/test_auto_buy_integration.py -v
```

---

## üö® Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: "Auto-buy is disabled"

**–†–µ—à–µ–Ω–∏–µ:** –í–∫–ª—é—á–∏—Ç–µ –∞–≤—Ç–æ–ø–æ–∫—É–ø–∫—É:
```bash
/autobuy on
```

### –ü—Ä–æ–±–ª–µ–º–∞: "Discount 18.0% < 30.0%"

**–†–µ—à–µ–Ω–∏–µ:** –°–Ω–∏–∑—å—Ç–µ –ø–æ—Ä–æ–≥ —Å–∫–∏–¥–∫–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∏–ª–∏ –¥–æ–∂–¥–∏—Ç–µ—Å—å –±–æ–ª–µ–µ –≤—ã–≥–æ–¥–Ω–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.

### –ü—Ä–æ–±–ª–µ–º–∞: "Price $150.00 > $100.00"

**–†–µ—à–µ–Ω–∏–µ:** –£–≤–µ–ª–∏—á—å—Ç–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Ü–µ–Ω—É –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö:
```python
config.max_price_usd = 200.0
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ü–æ–∫—É–ø–∫–∏ –Ω–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
1. DRY_RUN —Ä–µ–∂–∏–º –≤–∫–ª—é—á–µ–Ω? (`/autobuy` –ø–æ–∫–∞–∂–µ—Ç "üîí DRY_RUN")
2. API –∫–ª—é—á–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã? (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ `.env` —Ñ–∞–π–ª)
3. –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–∞–Ω—Å–∞? (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `/balance`)

---

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –°–∫–æ—Ä–æ—Å—Ç—å –ø–æ–∫—É–ø–∫–∏

- **–í—Ä–µ–º—è —Ä–µ–∞–∫—Ü–∏–∏**: ~100-300 –º—Å (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø–∏–Ω–≥–∞ –¥–æ DMarket API)
- **Keep-Alive —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è**: –≠–∫–æ–Ω–æ–º—è—Ç 50-100 –º—Å –Ω–∞ –∫–∞–∂–¥–æ–π –ø–æ–∫—É–ø–∫–µ
- **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–≥—Ä –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

```python
# –£–≤–µ–ª–∏—á–∏—Ç—å connection pool –¥–ª—è –±–æ–ª—å—à–µ–≥–æ throughput
client = httpx.AsyncClient(
    limits=httpx.Limits(
        max_keepalive_connections=20,
        max_connections=50
    )
)
```

---

## üìö –°–º. —Ç–∞–∫–∂–µ

- [DMarket API Documentation](https://docs.dmarket.com/)
- [Arbitrage Scanner Guide](../docs/ARBITRAGE.md)
- [Notification System](../docs/NOTIFICATION_FILTERS_GUIDE.md)
- [Security Best Practices](../SECURITY.md)

---

**–°–æ–∑–¥–∞–Ω–æ:** 2 —è–Ω–≤–∞—Ä—è 2026
**–ê–≤—Ç–æ—Ä:** DMarket Telegram Bot Team
**–í–µ—Ä—Å–∏—è:** 1.0.0
